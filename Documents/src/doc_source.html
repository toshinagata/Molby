<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>Molby</title>
<link rel="stylesheet" href="../etc/style.css" type="text/css" />
</head>

<body>

<div file="index.html">
<link id="#header" />
<div class="centered" lang="en">
<h1>Molby</h1>
<h2>An Interactive Molecular Modeling Software<br />with Integrated Ruby Interpreter</h2>
<h3>Version 0.6.5</h3> <!-- version -->
<h3>Toshi Nagata</h3>
<p><a href="http://molby.sourceforge.jp/index-en.html">http://molby.sourceforge.jp/index-en.html</a></p>
</div>
<div class="centered" lang="ja">
<h1>Molby</h1>
<h2>対話型分子モデリングソフトウェア<br />（Ruby インタプリタ内蔵）</h2>
<h3>Version 0.6.5</h3> <!-- version -->
<h3>永田　央</h3>
<p><a href="http://molby.sourceforge.jp/index.html">http://molby.sourceforge.jp/index.html</a></p>
</div>
<hr />
<div class="contents" lang="en">
<h2>Table of Contents</h2>
<link id="#toc_all" />
</div>
<div class="contents" lang="ja">
<h2>目次</h2>
<link id="#toc_all" />
</div>
<link id="#navigation" />
</div>

<div file="introduction.html">
<link rel="Up" href="index.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>Introduction</h1>
<link id="#toc" />
</div>
<div class="contents" lang="ja">
<h1>はじめに</h1>
<link id="#toc" />
</div>
<link id="#navigation" />
</div>

<div file="whatis.html">
<link rel="Up" href="introduction.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>What is Molby?</h1>
<p>
Molby is an application to visualize and build molecular models interactively through 3D display. It provides the following capability:
</p>
<ul>
<li>Viewing molecular models in either ball-and-stick or "line" display.</li>
<li>Interactive modification of molecular models by mouse operation.</li>
<li>Optimization of the structure by molecular mechanics calculation. Also capable is the molecular dynamics calculation.</li>
<li>Viewing and editing atomic coordinates, molecular mechanics atom typs, and other parameters in tables.</li>
<li>Importing and exporting structure/coordinate data for other program packages such as Gaussian, GAMESS, NAMD and SHELX.</li>
<li>Embedded Ruby interpreter for automated processing of molecular models.</li>
</ul>
</div>
<div class="contents" lang="ja">
<h1>Molbyとは？</h1>
<p>
Molby は、分子を 3D 表示して、画面上で分子モデルを構築するためのアプリケーションです。以下のような機能があります。
</p>
<ul>
<li>分子を ball-and-stick または「線」で表示できます。</li>
<li>分子モデルをマウス操作で編集できます。</li>
<li>分子力学計算による構造最適化ができます。分子動力学計算も可能です。</li>
<li>原子座標や分子力学の原子タイプなどのパラメータを、テーブルで編集できます。</li>
<li>Gaussian, GAMESS, NAMD, SHELX などの他のプログラムパッケージのファイルを読み込み／書き出しできます。</li>
<li>分子モデルの操作を自動化できるように Ruby インタプリタを内蔵しています。</li>
</ul>
</div>
<link id="#navigation" />
</div>

<div file="installation.html">
<link rel="Up" href="introduction.html" />
<link rel="Prev" href="whatis.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>Installation</h1>
<h2>1. Supported Platforms</h2>
<p>
Molby runs on the following platforms.
</p>
<ul>
<li>Microsoft Windows (XP or later).</li>
<li>Mac OS X (10.5 or later, PowerPC or Intel).</li>
</ul>

<p>
Installation procedures are described below for each of these platforms.
</p>

<h2>2. Get the Software</h2>
<p>
Download from the official distribution web site, <a href="http://en.sourceforge.jp/projects/molby/">http://en.sourceforge.jp/projects/molby/</a>.
</p>

<h2>3. Installation</h2>

<h3>3-1. Microsoft Windows</h3>

<p>
The Windows version is provided as a standard setup package (<code>SetupMolby.exe</code>). Double-click the setup package, and follow the instructions. If you are not sure, just select "OK" to go proceed.
</p>
<p>
After installation is finished, you will find the Molby application registered in the "Start" menu under the item "All Programs."
</p>

<h3>3-2. Mac OS X</h3>
<p>
The Mac version is provided as a disk image (<code>Molby.dmg</code>). Double-click the disk image file, and you will find a virtual disk drive mounted on the desktop. Find the Molby application inside it, and drag it to the "Applications" folder in your hard drive.
</p>
<p>
<span class="italic">Note:</span> The Mac version is provided as a universal binary, which runs natively on both PowerPC and Intel platforms.
</p>

<h2>4. Uninstallation</h2>
<h3>4-1. Microsoft Windows</h3>
<p>
Use the uninstaller in the Molby folder. You can access the Molby folder from the "Start" menu (Start -&gt; All Programs -&gt; Molby).
</p>
<h3>4-2. Mac OS X</h3>
<p>
Trash the Molby application in the "Applications" folder.
</p>

</div>
<div class="contents" lang="ja">
<h1>インストール</h1>
<h2>1. サポートするプラットフォーム</h2>
<p>
Molbyは以下のプラットフォームで動作します。
</p>
<ul>
<li>Microsoft Windows (XPまたはそれ以降).</li>
<li>Mac OS X (10.5またはそれ以降, PowerPCまたはIntel).</li>
</ul>

<p>
それぞれのプラットフォームでのインストール方法を、以下に説明します。
</p>

<h2>2. ソフトウェアの入手</h2>
<p>
公式配布サイト <a href="http://sourceforge.jp/projects/molby/">http://sourceforge.jp/projects/molby/</a> から最新版をダウンロードしてください。
</p>

<h2>3. インストール</h2>

<h3>3-1. Microsoft Windows</h3>

<p>
Windows版は、標準のセットアップパッケージ (<code>SetupMolby.exe</code>) で配布されています。セットアップパッケージをダブルクリックして、指示に従ってください。どうしたらよいかわからない時は、"OK"を押して進んで構いません。
</p>
<p>
インストールが終了したら、「スタート」メニューの「すべてのプログラム」の中に Molby が入っているはずです。
</p>

<h3>3-2. Mac OS X</h3>
<p>
Mac版は、ディスクイメージ (<code>Molby.dmg</code>) で配布されています。ディスクイメージをダブルクリックすると、仮想ディスクがデスクトップにマウントされます。Molby アプリケーションがその中にありますので、ハードディスクの「アプリケーション」フォルダにドラッグコピーしてください。
</p>
<p>
<span class="italic">注:</span> Mac 版は universal binary です。PowerPC, Intel の両方のマシンで動作します。
</p>

<h2>4. アンインストール</h2>
<h3>4-1. Microsoft Windows</h3>
<p>
Molbyフォルダの中にアンインストーラがあります。「スタート」メニューで「すべてのプログラム」-&gt; Molby とたどってください。
</p>
<h3>4-2. Mac OS X</h3>
<p>
「アプリケーション」フォルダの中の Molby アプリケーションをゴミ箱に捨てます。
</p>

</div>
<link id="#navigation" />
</div>

<div file="copyright.html">
<link rel="Up" href="introduction.html" />
<link rel="Prev" href="installation.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>Copyright and License</h1>
<h2>1. Copyright Notice</h2>
<p>
Molby is a copyrighted product of Toshi Nagata.
</p>
<p>
Copyright (C) 2008-2014 Toshi Nagata <!-- copyright -->
</p>
<p>
Molby includes the following softwares, which are copyrighted products as described below:
</p>
<ul>
<li>
<a href="http://ambermd.org/">AmberTools 1.3</a>: Copyright (C) Junmei Wang, Ross C. Walker, Michael F. Crowley, Scott Brozell and David A. Case
</li>
<li>
<a href="http://www.wxwidgets.org/">wxWidgets 3.0.0</a>: Copyright (C) 1992-2013 Julian Smart, Robert Roebling, Vadim Zeitlin and other members of the wxWidgets team. Portions (c) 1996 Artificial Intelligence Applications Institute
</li>
<li>
<a href="http://www.ruby-lang.org/">Ruby 2.0.0</a>: Copyright (C) 1993-2013 Yukihiro Matsumoto
</li>
<li>
<a href="http://www.netlib.org/clapack/">CLAPACK</a>: Copyright (C) 1992-2008 The University of Tennessee.  All rights reserved.
</li>
<li>
<a href="http://www.fftw.org/">FFTW 3.3.2</a>: Copyright (C) 2003, 2007-11 Matteo Frigo and Massachusetts Institute of Technology
</li>
<li>
<a href="http://web.ornl.gov/sci/ortep/">ORTEP III</a>: The citation is made like below. There are no copyright notice, but it is likely to be put in public domain.<br />
Burnett, M. N.; Johnson, C. K. <i>ORTEP-III: Oak Ridge Thermal Ellipsoid Plot Program for Crystal Structure Illustrations,</i> Oak Ridge National Laboratory Report ORNL-6895, 1996.
</li>
</ul>

<h2>2. License</h2>
<p>
Molby is distributed under the GNU General Public License (version 2).
</p>
<blockquote>
<p>
Molby: An Interactive Molecular Modeling Software with Integrated Ruby Interpreter
</p>
<p>
Copyright (C) 2008-2014 Toshi Nagata <!-- copyright -->
</p>
<p>
This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 2 of the License, or
(at your option) any later version.
</p>
<p>
This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<a href="../etc/gpl.txt">GNU General Public License</a> for more details.
</p>
</blockquote>
</div>
<div class="contents" lang="ja">
<h1>著作権とライセンス</h1>
<h2>1. 著作権表示</h2>
<p>
Molby の著作権は永田　央が保持しています。
</p>
<p>
Copyright (C) 2008-2014 Toshi Nagata <!-- copyright -->
</p>
<p>
Molby は以下のソフトウェアを含んでいます。それぞれの著作権表示は下の通りです。
</p>
<ul>
<li>
<a href="http://ambermd.org/">AmberTools 1.3</a>: Copyright (C) Junmei Wang, Ross C. Walker, Michael F. Crowley, Scott Brozell and David A. Case
</li>
<li>
<a href="http://www.wxwidgets.org/">wxWidgets 3.0.0</a>: Copyright (C) 1992-2013 Julian Smart, Robert Roebling, Vadim Zeitlin and other members of the wxWidgets team. Portions (c) 1996 Artificial Intelligence Applications Institute
</li>
<li>
<a href="http://www.ruby-lang.org/">Ruby 2.0.0</a>: Copyright (C) 1993-2013 Yukihiro Matsumoto
</li>
<li>
<a href="http://www.netlib.org/clapack/">CLAPACK</a>: Copyright (C) 1992-2008 The University of Tennessee.  All rights reserved.
</li>
<li>
<a href="http://www.fftw.org/">FFTW 3.3.2</a>: Copyright (C) 2003, 2007-11 Matteo Frigo and Massachusetts Institute of Technology
</li>
<li>
<a href="http://web.ornl.gov/sci/ortep/">ORTEP III</a>: The citation is made like below. There are no copyright notice, but it is likely to be put in public domain.<br />
Burnett, M. N.; Johnson, C. K. <i>ORTEP-III: Oak Ridge Thermal Ellipsoid Plot Program for Crystal Structure Illustrations,</i> Oak Ridge National Laboratory Report ORNL-6895, 1996.
</li>
</ul>

<h2>2. ライセンス</h2>
<p>
Molby は <a href="../etc/gpl.txt">GNU General Public License (GNU 一般公衆利用許諾契約書, version 2)</a> に従って配布します。
</p>
<blockquote>
<p>
Molby: 対話型分子モデルソフトウェア（Ruby インタプリタ内蔵）
</p>
<p>
Copyright (C) 2008-2014 Toshi Nagata <!-- copyright -->
</p>
<p>
このプログラムはフリーソフトウェアです。あなたはこれを、フリーソフトウェア財団によって発行された GNU 一般公衆利用許諾契約書(バージョン2か、希望によってはそれ以降のバージョンのうちどれか)の定める条件の下で再頒布または改変することができます。
</p>
<p>
このプログラムは有用であることを願って頒布されますが、*全くの無保証* です。商業可能性の保証や特定の目的への適合性は、言外に示されたものも含め全く存在しません。詳しくはGNU 一般公衆利用許諾契約書をご覧ください。
</p>
</blockquote>
<p>
参考のため、GNU 一般公衆利用許諾契約書の<a href="../etc/gpl.ja.txt">非公式日本語訳</a>を添付します。ただし、正式な文書は英語版の方です。
</p>
</div>
<link id="#navigation" />
</div>

<div file="tutorials.html">
<link rel="Up" href="index.html" />
<link rel="Prev" href="introduction.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>Tutorials</h1>
<link id="#toc" />
</div>
<div class="contents" lang="ja">
<h1>チュートリアル</h1>
<link id="#toc" />
</div>
<link id="#navigation" />
</div>

<div file="drawing.html">
<link rel="Up" href="tutorials.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>Step One: Draw a New Molecule</h1>
<h2>1. Create a Molecule</h2>
<p>
Start up Molby. You will see a blank window like below. This is the main window to manipulate your molecule.
</p>
<p><img src="../etc/draw_01.png" /></p>
<p>
Suppose you want a benzene molecule. Double-click on the black area, and you will be asked to "enter formula". Type "C6H6" and hit "OK".
</p>
<p><img src="../etc/draw_02.png" /></p>
<p>
Then you see a benzene molecule in the black area. The atoms and bonds are drawn in red, which means these atoms and bonds are "selected". On the left to this area, there is a table, which shows in numbers the positions of all atoms, and other useful information. We will get into this part in more details later.
</p>
<p><img src="../etc/draw_03.png" /></p>
<h2>2. Rotate the Molecule</h2>
<p>
You can rotate the molecule around by use of the three bars on the both sides and the bottom of the black area. Press the left button of the mouse on one of these bars, and try dragging.
</p>
<p><img src="../etc/draw_04.png" /></p>
<ul>
<li>Bar 1: rotate the whole molecule around the horizontal axis.</li>
<li>Bar 2: rotate the whole molecule around the vertical axis.</li>
<li>Bar 3: rotate the selected part of the molecule. (In the present example, the whole molecule is selected, so that the bar 3 works in the same manner as the bar 2.)</li>
</ul>
<p>
Next, look at the buttons above the black area. The left-most button "Rot" is now selected. This means the window is in the "Rotation" mode. In this case, you can drag in the black area to rotate freely the whole molecule.
</p>
<p class="note">
<span class="italic">Note:</span> Be careful not to start drag from a very near point to the molecule. If you start drag on a selected atom or bond, the selected part will move along the mouse, instead of the whole molecule to rotate.
</p>

<h2>3. Translate and Scale</h2>
<p>
Press the button "Trans" above the black area. The window is now in "Translate" mode. When you drag in the black area, the whole molecule moves along with the mouse movement.
</p>
<p class="note">
<span class="italic">Note:</span> the functions of the rotation bars do not change.
</p>
<p><img src="../etc/draw_05.png" /></p>
<p>
Next, press the button "Scale". The window is now in "Scale" mode, and you can expand and shrink the molecule by dragging in the black area.
</p>
<p><img src="../etc/draw_06.png" /></p>
<p>
The "Fit to Screen" menu command, avaiable under the "Show" menu, is a convenient way to fit the whole molecule to the window.
</p>
<p><img src="../etc/draw_07.png" /></p>
<p>
Now you have learned how to move the whole molecule around. In the next chapter, you will learn how to edit the molecule.
</p>
</div>

<div class="contents" lang="ja">
<h1>第一段階：新しい分子を描く</h1>
<h2>1. 分子を作る</h2>
<p>
Molbyを立ち上げてください。下のような空のウィンドウが現れます。このウィンドウが、分子を取り扱うためのメインウィンドウです。
</p>
<p><img src="../etc/draw_01.png" /></p>
<p>
ベンゼン分子を作ってみたいとします。画面の黒いところ（編集エリア）をダブルクリックすると、"enter formula" と指示が出ます。"C6H6" とタイプして、OK を押します。
</p>
<p><img src="../etc/draw_02.png" /></p>
<p>
編集エリアにベンゼン分子が現れます。原子と結合は赤色で描かれていますが、これは「選択されている」という表示です。左側には表があり、原子の位置などの情報を数値で表示しています。この部分については、あとで詳しい使い方が出てきます。
</p>
<p><img src="../etc/draw_03.png" /></p>
<h2>2. 分子を回転させる</h2>
<p>
編集エリアの両側と下には、分子を回転させるバーがあります。このバーでマウスボタンを押し、そのままドラッグしてみてください。
</p>
<p><img src="../etc/draw_04.png" /></p>
<ul>
<li>バー１：水平軸の周りに分子を回転させる。</li>
<li>バー２：垂直軸の周りに分子を回転させる。</li>
<li>バー３：分子の選択部分を回転させる。（今は分子全体が選択されているため、バー２と同じ動作をします。）</li>
</ul>
<p>
次に、編集エリアの上にあるボタンを見てください。一番左の "Rot" が選択されています。これは、このウィンドウが現在「回転 (Rotation)」モードにあることを示しています。この場合、編集エリアでマウスをドラッグすると、分子全体を自由に回転させることができます。
</p>
<p class="note">
<span class="italic">注:</span> 分子に近すぎるところからドラッグを始めないように注意してください。選択している原子・結合の上でドラッグを始めると、選択部分がマウスについて動いてしまい、分子全体を動かすことができません。
</p>
<h2>3. Translate and scale</h2>
<p>
"Trans" と書かれたボタンを押してください。ウィンドウは「並進 (Translate)」モードになります。編集エリアでマウスをドラッグすると、分子全体を平行移動させることができます。
</p>
<p class="note">
<span class="italic">注:</span> 回転バーの機能は変わりません。
</p>
<p><img src="../etc/draw_05.png" /></p>
<p>
次に、"Scale" と書かれたボタンを押してください。ウィンドウは「拡大縮小 (Scale)」モードになります。編集エリアでマウスをドラッグすると、分子全体を拡大・縮小することができます。
</p>
<p><img src="../etc/draw_06.png" /></p>
<p>
"Show" メニューの中に "Fit to Screen" メニューコマンドがあります。このコマンドは、分子をウィンドウサイズに合わせて表示したいときに便利です。
</p>
<p><img src="../etc/draw_07.png" /></p>
<p>
分子を画面上で動かす方法がわかりました。次は、編集のやり方を説明します。
</p>
</div>
<link id="#navigation" />
</div>

<div file="editing.html">
<link rel="Up" href="tutorials.html" />
<link rel="Prev" href="drawing.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>Step Two: Edit a Molecule</h1>
<h2>1. Append a Substituent</h2>
<p>
Suppose you have a benzene molecule now, and want to append a methyl substituent to give a toluene.
</p>
<p>
Press the button "Select", and click on the black area where no atom nor bond is present. The selection becomes canceled.
</p>
<p><img src="../etc/edit_01.png" /></p>
<p>
Select one of the hydrogen atoms. There are two ways to do this. You can click on the target atom, or you can drag to select atoms within a rectangular region.
</p>
<p><img src="../etc/edit_02.png" /> <img src="../etc/edit_03.png" /></p>
<p>
Double-click on the hydrogen atom. This time, be sure to hit the selection! Then you will see the dialog "enter formula" as shown below. Type "CH3" in the text box and hit "OK".
</p>
<p><img src="../etc/edit_04.png" /></p>
<p>
Now you get toluene.
</p>
<p><img src="../etc/edit_05.png" /></p>
<p>
You want to save the result to a file. Select "Save as..." from the File menu, choose the file format, enter the filename, and hit "Save".
</p>
<p>
The "native" file format in Molby is "mbsf", i.e. <u>M</u>ol<u>b</u>y <u>S</u>tructure <u>F</u>ile. The mbsf format is a private format with no compatibility with any existing file format for chemistry. Nevertheless, it is a plain text file that is reasonably compact and easy to read. Unless you have a particular reason to choose other formats, it is recommended that you save the structues as a "mbsf" file.
</p>
<h2>2. Manipulate Molecular Fragments</h2>
<p>
After building a molecule, you may want to move some part of a molecule. Here are examples how you can do it.
</p>
<p>
Select the methyl group of the toluene, if you have not done so yet <span class="note">(Tip: you can add to the current selection by shift-clicking)</span>. Press the left rotation bar (marked "3" in the previous page), and drag up and down. You will see the methyl group rotates to the right and left.
</p>
<p><img src="../etc/edit_06.png" /></p>
<p>
The same manipulation can be achieved by selecting one bond and dragging the left rotation bar. In this case, you can also rotate the benzene ring (with the methyl group fixed) by pressing Option (Mac) or Alt (Win) key when dragging.
</p>
<p><img src="../etc/edit_07.png" /></p>
<p>
The selected atoms can be dragged to give a translational move. Use this feature with care, because it may result in a chemically unnatural structure.
</p>
<p><img src="../etc/edit_08.png" /></p>
<h2>3. Adding and Deleting Atoms</h2>
<p>
We have already learned one way to add atoms: double-clicking on the selected part of the molecule (or on the black area where nothing is present), and type-in the formula. Actually, this is the most convenient way to add atoms in Molby. However, there are also other ways to add atoms.
</p>
<p>
Look at our familiar toluene molecule. Suppose we want to convert it to indane.
</p>
<p><img src="../etc/indane.png" /> indane</p>
<p>
Rotate the molecule so that its orientation matches the chemical structure. We will start from C3, add two carbons, and then close the ring.
</p>
<p><img src="../etc/edit_09.png" /></p>
<p>
Press the "Erase" button above the black area. Click on the "H3" hydrogen. The hydrogen atom and the bond between C3 and H3 disappear.
</p>
<p><img src="../etc/edit_10.png" /></p>
<p>
Press the "Bond" button. Drag from the C3 atom to the right-bottom, and release the mouse button. A new atom and a bond to C3 are created. Drag from the new atom to the right-up, and another atom and bond are created.
</p>
<p><img src="../etc/edit_11.png" /> <img src="../etc/edit_12.png" /></p>
<p>
Press the "Erase" button again, and erase one hydrogen from the methyl group. Press the "Select" button, select the benzene-methylene bond, and rotate the methylene group as appropriate for the five-membered ring, by use of the left rotation bar.
</p>
<p><img src="../etc/edit_13.png" /> <img src="../etc/edit_14.png" /></p>
<p>
Now you can close the ring. Press the "Bond" button, and drag from the methylene carbon. When the mouse cursor comes close enough to the target carbon, the new atom will snap to the target and make a new bond. Then release the mouse button.
</p>
<p><img src="../etc/edit_15.png" /></p>
<p>
Finally, you want to add hydrogens to the newly created carbons. Press the "Select" button, and select these two carbons. Go to the "Edit" menu, and select the "Add Hydrogen" -&gt; "Tetrahedral sp3" menu command.
</p>
<p><img src="../etc/edit_16.png" /></p>
<p>
Here is the result.
</p>
<p><img src="../etc/edit_17.png" /></p>
<p class="note">
A similar result can be achieved by selecting the hydrogen ortho to the methyl group, double-click it, type "CH2CH3" in, erase one hydrogen atom from each of the methyl groups, and make a bond. This is better because the newly created methylenes have reasonable bond lengths and angles as methylene groups. The above example is just for explanation of the editing features.
</p>
</div>
<div class="contents" lang="ja">
<h1>第二段階：分子を編集する</h1>
<h2>1. 置換基をつける</h2>
<p>
ベンゼン分子があり、これにメチル基をつけてトルエンを作りたいとします。
</p>
<p>
"Select"ボタンを押して、編集エリアの原子や結合がないところをクリックします。選択が解除され、分子の表示が赤から原子ごとの色に変わります。
</p>
<p><img src="../etc/edit_01.png" /></p>
<p>
水素原子の一つを選択します。やり方は二つあります。選択したい原子をクリックするか、またはドラッグで現れる四角い領域の中の原子を選択します。
</p>
<p><img src="../etc/edit_02.png" /> <img src="../etc/edit_03.png" /></p>
<p>
水素原子の上でダブルクリックします。このとき、選択部分の上でダブルクリックするように注意してください。"Enter formula"というダイアログが出てきます。"CH3"と入力し、"OK"を押します。
</p>
<p><img src="../etc/edit_04.png" /></p>
<p>
トルエンができました。
</p>
<p><img src="../etc/edit_05.png" /></p>
<p>
ファイルに保存しておきたい時は、通常通り File メニューから "Save as..." を選び、ファイルフォーマットを選び、ファイル名をタイプして "Save" を押します。
</p>
<p>
Molby の標準ファイルフォーマットは "mbsf" (<u>M</u>ol<u>b</u>y <u>S</u>tructure <u>F</u>ile) です。Mbsf フォーマットは独自のもので、既存の化学ファイルフォーマットとは互換性がありません。しかし、mbsfはテキストファイルであり、比較的コンパクトで、読みやすいものです。他のフォーマットで保存する積極的な理由がない場合は、"mbsf"フォーマットで保存しておくことをおすすめします。
</p>

<h2>2. 分子の一部を操作する</h2>
<p>
分子を組み立てたら、その一部を動かしたくなることがあります。ここでは、そのやり方の例を示します。
</p>
<p>
トルエンのメチル基を選択します<span class="note">（コツ：シフトキーを押しながらクリックすると、現在の選択範囲に原子を付け加えることができます）</span>。左の回転バー（前ページで③と書かれていたもの）でマウスボタンを押し、上下にドラッグしてください。メチル基が右左に回転するのがわかります。
</p>
<p><img src="../etc/edit_06.png" /></p>
<p>
同じ操作は、結合を１つ選択して左の回転バーをドラッグしてもできます。この場合、メチル基を固定してベンゼン環の方を回すこともできます。ドラッグの時にOptionキー(Mac)、Altキー(Win)を押してください。
</p>
<p><img src="../etc/edit_07.png" /></p>
<p>
選択した原子をドラッグすると平行移動できます。化学的に不自然な構造になりますので、注意が必要です。
</p>
<p><img src="../etc/edit_08.png" /></p>
<h2>3. 原子を追加する・削除する</h2>
<p>
原子を追加する方法はすでに一つ説明しました。選択部分または編集エリアの何もないところをダブルクリックして、構造式をタイプする方法です。実際、Molbyで原子を追加するにはこれが最も便利です。しかし、他の方法もありますので、それを紹介します。
</p>
<p>
先ほどのトルエン分子を使います。これをインダンに変えたいとします。
</p>
<p><img src="../etc/indane.png" /> インダン</p>
<p>
分子を回転させて、化学構造式と同じ向きになるようにします。C3から始めて、炭素原子を２つ追加し、環を閉じることにします。
</p>
<p><img src="../etc/edit_09.png" /></p>
<p>
編集エリアの上の"Erase"ボタンを押します。"H3"水素をクリックします。この水素原子と、C3-H3の結合が消えます。
</p>
<p><img src="../etc/edit_10.png" /></p>
<p>
"Bond"ボタンを押します。C3原子から右下にドラッグし、マウスボタンを離します。新しい原子と、その原子とC3の間の結合が新しく作られます。新しい原子から右上にドラッグすると、もう一つの原子と結合が作られます。
</p>
<p><img src="../etc/edit_11.png" /> <img src="../etc/edit_12.png" /></p>
<p>
"Erase"ボタンをもう一度押して、メチル基の原子を一つ消します。"Select"ボタンを押して、ベンゼン環とメチレン炭素（今水素原子を一つ消したところ）の間の結合を選択します。左の回転バーを使って、五員環に適切な向きになるようにメチレン基を回転させます。
</p>
<p><img src="../etc/edit_13.png" /> <img src="../etc/edit_14.png" /></p>
<p>
環を閉じます。"Bond"ボタンを押し、メチレン炭素原子から右下の炭素原子へドラッグします。マウスカーソルが目標の炭素原子に近づくと、ドラッグしてできた結合が炭素原子にくっつきます。ここでマウスボタンを離します。
</p>
<p><img src="../etc/edit_15.png" /></p>
<p>
最後に、新しく作った二つの炭素原子に水素原子を付加します。"Select"ボタンを押して、マウスを使って二つの炭素原子を選択します。"Edit"メニューから、"Add Hydrogen"-&gt;"Tetrahedral sp3"コマンドを実行します。
</p>
<p><img src="../etc/edit_16.png" /></p>
<p>
結果はこのようになります。
</p>
<p><img src="../etc/edit_17.png" /></p>
<p class="note">
トルエンからインダンは次のような操作でも作ることができます。メチル基のオルト位の水素原子を選択、ダブルクリック、ダイアログが出たら"CH2CH3"と入力、二つのメチル基からそれぞれ水素原子を一つ削除、結合回転で向きを調整、結合を作成。この方法の方が、新しく作ったメチレン基の結合距離・結合角が正しくなるため、よりよい結果になります。上の例は、編集操作の説明のためのものと考えてください。
</p>
</div>
<link id="#navigation" />
</div>

<div file="cut_copy_paste.html">
<link rel="Up" href="tutorials.html" />
<link rel="Prev" href="editing.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>Step Three: Edit a Molecule: Cut/Copy/Paste</h1>
<p>
Like any other decent "editing" applications, Molby has a capability of cut/copy/paste by use of a clipboard. These functions (especially copy and paste) are also quite useful for building complex molecules.
</p>
<p>
We start from the toluene molecule again. Select the methyl group and do copy.
</p>
<p><img src="../etc/copy_01.png" /></p>
<p>
Unselect the methyl group, and do paste. Another methyl group appears, with no connection to the existing atoms. This is how "paste" works when nothing is selected beforehand.
</p>
<p><img src="../etc/copy_02.png" /></p>
<p>
Now we will see what happens when something is selected before pasting. As described above, start with the toluene molecule, select the methyl group, and copy it. Unselect the methyl group, and this time select the hydrogen atom that is "ortho" to the methyl group.
</p>
<p><img src="../etc/copy_03.png" /></p>
<p>
Do paste. The selected hydrogen atom is replaced with the pasted methyl group. Note that a new bond is created between the pasted methyl carbon and the ortho carbon, with an acceptable bond length and angles. 
</p>
<p class="note">
The dihedral angle may not be acceptable. In that case, you can rotate the pasted fragment by use of the left rotation bar until the dihedral angle looks good.
</p>
<p><img src="../etc/copy_04.png" /></p>
<p>
This "select and paste" technique is very useful for building large molecules. Suppose we want to build an oligobenzamide.
</p>
<p><img src="../etc/copy_05.png" /></p>
<p>
Create a "monomer", i.e. N-methyl-4-acetamidobenzamide. This is done by (1) create a benzene, (2) select H1, double-click, and enter "CONHCH3", (3) select H4, double-click, and enter "NHCOCH3". After entering each formula, you need to rotate the fragment to make the dihedral angle appropriate.
</p>
<p><img src="../etc/copy_06.png" /></p>
<p>
Select the whole molecule except for the COCH3 group at the left. Do copy.
</p>
<p><img src="../etc/copy_07.png" /></p>
<p>
Select the NHCH3 group at the right. Do paste.
</p>
<p><img src="../etc/copy_08.png" /></p>
<p>
A new amide bond is created and the dimer is formed.
</p>
<p><img src="../etc/copy_09.png" /></p>
<p>
Select "Fit to Screen" from the "Show" menu, to make the whole molecule visible.
</p>
<p><img src="../etc/copy_10.png" /></p>
<p>
Repeat these procedures to make the tetramer.
</p>
<p><img src="../etc/copy_11.png" /></p>
<p><img src="../etc/copy_12.png" /></p>
<p><img src="../etc/copy_13.png" /></p>
<p><img src="../etc/copy_14.png" /></p>
<p>
Make one more iteration to make the octamer.
</p>
<p><img src="../etc/copy_15.png" /></p>
</div>
<div class="contents" lang="ja">
<h1>第三段階：分子を編集する：カット・コピー・ペースト</h1>
<p>
他のアプリケーションと同様に、Molby もクリップボードを使ってカット・コピー・ペーストを行う機能があります。これらの機能、特にコピー・ペーストは複雑な分子を作るときにたいへん有用です。
</p>
<p>
ふたたびトルエン分子から始めます。メチル基を選択して、コピーします。
</p>
<p><img src="../etc/copy_01.png" /></p>
<p>
メチル基の選択を解除して、ペーストを実行します。他の原子と結合していないメチル基がもう一つ現れます。原子が選択されていない状態で「ペースト」すると、このような動作になります。
</p>
<p><img src="../etc/copy_02.png" /></p>
<p>
今度は、ペーストする前に原子が選択されているときにどうなるかを見てみます。上と同じように、トルエンから始めて、メチル基を選択して、コピーします。メチル基の選択を解除して、今度はメチル基のオルト位の水素原子を選択します。
</p>
<p><img src="../etc/copy_03.png" /></p>
<p>
ペーストを実行します。選択された水素原子がメチル基に置き換わります。オルト位の炭素とメチル基の間に新しい結合ができ、その長さと結合角が適切なものになっていることがわかります。
</p>
<p class="note">
二面角は適切でないこともあります。その場合は、ペーストされたグループを左の回転バーを使って回転させて、適切な二面角にします。
</p>
<p><img src="../etc/copy_04.png" /></p>
<p>
この「選択してペースト」のテクニックは、大きな分子を作るときにたいへん役に立ちます。たとえば、オリゴベンズアミドを作りたいとします。
</p>
<p><img src="../etc/copy_05.png" /></p>
<p>
まず、「モノマー」となる N-メチル-4-アセトアミドベンズアミドを作ります。次のようにします：(1) ベンゼンを作る、(2) H1 を選択してダブルクリックし、「CONHCH3」とタイプする、(3) H4 を選択してダブルクリックし、「NHCOCH3」とタイプする。化学式をタイプしたあとは、作成したフラグメントを回転させて二面角を調整しておきます。
</p>
<p><img src="../etc/copy_06.png" /></p>
<p>
左端の COCH3 以外全部を選択し、コピーします。
</p>
<p><img src="../etc/copy_07.png" /></p>
<p>
右端の NHCH3 を選択し、「ペースト」を実行します。
</p>
<p><img src="../etc/copy_08.png" /></p>
<p>
新しくアミド結合が作られ、二量体ができます。
</p>
<p><img src="../etc/copy_09.png" /></p>
<p>
"Show" メニューから "Fit to Screen" を選び、分子全体が見えるようにします。
</p>
<p><img src="../etc/copy_10.png" /></p>
<p>
この操作を繰り返して、四量体を作ります。
</p>
<p><img src="../etc/copy_11.png" /></p>
<p><img src="../etc/copy_12.png" /></p>
<p><img src="../etc/copy_13.png" /></p>
<p><img src="../etc/copy_14.png" /></p>
<p>
もう一度繰り返して、八量体を作ります。
</p>
<p><img src="../etc/copy_15.png" /></p>
</div>
<link id="#navigation" />
</div>

<div file="ring_fusion.html">
<link rel="Up" href="tutorials.html" />
<link rel="Prev" href="cut_copy_paste.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>Step Four: Ring Fusion</h1>
<h2>1. Ring fusion by double-click and type-in</h2>
<p>
Molby has a capability to create a fused ring structure. As an example, here is presented yet another method to make indane. This time, we start from a benzene.
</p>
<p><img src="../etc/ring_01.png" /></p>
<p>
Choose "select" mode, and select C1 and C2 by clicking on the C1-C2 bond.
</p>
<p><img src="../etc/ring_02.png" /></p>
<p>
Double-click on the selection, and enter "cyclopentane" in the dialog box.
</p>
<p><img src="../etc/ring_03.png" /></p>
<p>
After pressing "OK", you will see a five-membered ring fused to the benzene ring.
</p>
<p><img src="../etc/ring_04.png" /></p>
<p>
Ring fusion also works when three or more atoms are selected in the original structure. For example, select the consecutive three carbons in indane as follows.
</p>
<p><img src="../etc/ring_05.png" /></p>
<p>
Double-click on the selection, and enter "C6H6" (or "benzene").
</p>
<p><img src="../etc/ring_06.png" /></p>
<p>
Now we have acenaphthene...almost.
</p>
<p><img src="../etc/ring_07.png" /></p>
<p>
As shown in the above figure, there is an extra, leftover hydrogen atom on one bridgehead carbon. After all, Molby is not so smart --- it just removes one hydrogen from each terminal carbon atoms in the selection, and connect a portion of the fusing fragment ("benzene" in this case) so that the newly created ring has the same number of atoms. Consequently, the stereochemistry may become strange when sp3 carbons are present either in the original structure or in the fusing fragment. You may need to remove/append hydrogen atoms and clean up structures (see <a href="mm_minimize.html">"Energy Minimization"</a> for detail).
</p>
<h2>2. Ring fusion by copy-and-paste</h2>
<p>
There is another way to make a ring fused structure, which includes copy and paste. Starting again from a benzene.
</p>
<p><img src="../etc/ring_08.png" /></p>
<p>
Open the "File" menu, and select "Open Predefined" &rarr; "Alicyclic" &rarr; "cyclopentane".
</p>
<p><img src="../etc/ring_09.png" /></p>
<p>
A new window named "*cyclopentane*" opens with one cyclopentane molecule. Select a portion containing three CH2 groups, and copy it by command-C or ctrl-C.
</p>
<p><img src="../etc/ring_10.png" /></p>
<p>
Return to the benzene molecule again, and this time select H1 and H2 (not C1 and C2).
</p>
<p><img src="../etc/ring_11.png" /></p>
<p>
Do paste by command-V or ctrl-V. You now get a indane molecule.
</p>
<p><img src="../etc/ring_12.png" /></p>
<p>
This "copy-and-paste" actually works in a similar way to previously described example (see <a href="cut-copy-paste.html">"Cut/Copy/Paste"</a>). When both the current selection and the fragment in the pasteboard have two terminals, they are connected and ring fusion takes place. This method of ring fusion is slightly more complicated than the "double-click and type-in" method, but it may be easier to understand.
</p>
</div>
<div class="contents" lang="ja">
<h1>第四段階：縮環構造の作成</h1>
<h2>1. ダブルクリック／キー入力による縮環</h2>
<p>
Molby は縮環構造を作るための機能を持っています。例として、インダンを作るもう一つの方法を紹介します。今回は、ベンゼンから始めます。
</p>
<p><img src="../etc/ring_01.png" /></p>
<p>
"Select" モードにして、C1-C2 結合をクリックして C1 と C2 を選択します。
</p>
<p><img src="../etc/ring_02.png" /></p>
<p>
選択部分をダブルクリックして、ダイアログボックスに "cyclopentane" と入力します。
</p>
<p><img src="../etc/ring_03.png" /></p>
<p>
"OK" を押すと、５員環がベンゼン環に縮環します。
</p>
<p><img src="../etc/ring_04.png" /></p>
<p>
選択部分が３個以上の原子を含んでいても、縮環は可能です。例えば、インダンで図のように３つの連続した炭素原子を選択してみます。
</p>
<p><img src="../etc/ring_05.png" /></p>
<p>
選択部分をダブルクリックして、"C6H6"（または "benzene"）と入力します。
</p>
<p><img src="../etc/ring_06.png" /></p>
<p>
そうすると、アセナフテンができます...だいたい。
</p>
<p><img src="../etc/ring_07.png" /></p>
<p>
上の図に示したように、橋頭位の炭素に１つ余分な水素原子が残ってしまいます。実のところ、Molby はあんまり賢くありません。選択部分の両端の原子から水素原子を１つずつ取り除いて、縮環する分子（この場合はベンゼン）の一部をかわりに結合して、生成する環の原子数が一致するようにしているだけです。このため、元の選択部分または縮環する分子が sp3 炭素を含んでいると、立体化学が変になることがあります。水素原子を除いたり付け加えたりして、さらに構造を最適化する必要があるでしょう（詳しくは「<a href="mm_minimize.html">エネルギー最小化</a>」を見てください）。
</p>
<h2>2. コピー／ペーストによる縮環</h2>
<p>
縮環構造を作るには、コピー／ペーストを使ったもう一つの方法があります。またベンゼンから始めましょう。
</p>
<p><img src="../etc/ring_08.png" /></p>
<p>
"File" メニューを開き、"Open Predefined" &rarr; "Alicyclic" &rarr; "cyclopentane" を選んでください。
</p>
<p><img src="../etc/ring_09.png" /></p>
<p>
"*cyclopentane*"という名前の新しいウィンドウが開き、シクロペンタン分子が入っています。３つのメチレン基を選択して、コマンド-C またはコントロール-C でコピーしてください。
</p>
<p><img src="../etc/ring_10.png" /></p>
<p>
ベンゼン分子に戻って、今度は H1 と H2（C1 と C2 ではなく）を選択してください。
</p>
<p><img src="../etc/ring_11.png" /></p>
<p>
コマンド-V またはコントロール-V でペーストしてください。インダンができます。
</p>
<p><img src="../etc/ring_12.png" /></p>
<p>
この「コピー／ペースト」は、実は前に説明したのと (<a href="cut-copy-paste.html">カット／コピー／ペースト</a>) 同じように機能しています。現在の選択部分とクリップボードの内容がともに「２つの末端」を持っているとき、末端同士がつなぎあわされ、縮環したように見えるのです。この方法による縮環は「ダブルクリック／入力」の方法よりも少し複雑ですが、何が起きているかはこちらの方が理解しやすいかもしれません。
</p>
</div>
<link id="#navigation" />
</div>

<div file="proptable.html">
<link rel="Up" href="tutorials.html" />
<link rel="Prev" href="ring_fusion.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>Step Five: Edit a Molecule: Using a Property Table</h1>
<h2>1. The Property Table of a Molecule</h2>
<p>
A molecule has many properties. It has a set of atoms and bonds. An atom has a name, an atom type, an element, a weight (which can be derived from the element), a charge, coordinates, and so on. According to the custom in the biomolecular modeling, atoms are grouped in "residues." It also has a set of parameters used in molecular mechanics. Molby also has a limited support for quantum chemical calculations. In relation to that, a molecule in Molby can retain extra information such as MO coefficients.
</p>
<p>
Many of these information are accessible via the <span class="italic">property table</span>. The table is on the left side of the model window.
</p>
<p><img src="../etc/table_01.png" /></p>
<p>
The table now shows the properties of each atom, namely its name, type, element, "residue" name and index, coordinates and partial charge. The property can be edited by double-clicking on the text.
</p>
<p><img src="../etc/table_02.png" /></p>
<p>
When return (enter) or tab key is pressed, the edited value is finalized, and editing will continue on another cell. Pressing return, shift-return, tab, or shift-tab should cause editing of the bottom, above, right, or left cell, respectively. If you want to finish editing, use option- (or alt-) return key combination.
</p>
<p>
Several points are worth mentioning here.
</p>
<p>
(1) The atom index (the leftmost column) cannot be edited. If you want to change the order of the atoms, try using a "drag-and-drop" feature, as shown in the figure below.
</p>
<p><img src="../etc/table_03.png" />
<img src="../etc/table_04.png" /></p>
<p>
(2) The residue column shows the residue name and index separated by a period. Manual editing of this cell may lead to a surprising result. For example, if you change the residue name of atom 0 from "RES" to "XXX", all atoms having residue index "1" will also have the new residue name "XXX".
</p>
<p><img src="../etc/table_05.png" />
<img src="../etc/table_06.png" /></p>
<p>
This behavior is based on the principle that all residue names and indices should be consistent, <span class="italic">i.e.</span> the atoms having the same residue index should have the same residue name. This is sometimes convenient, but in many cases it causes confusion.
</p>
<p>
A more recommended way to change the residue name and index is to use the menu command "Assign Residue...", in the "Script" menu, after selecting atoms you want to assign one residue name and index.
</p>
<p>
<img src="../etc/table_07.png" />
&nbsp;&nbsp;&nbsp;&nbsp;
<img src="../etc/table_08.png" />
</p>
<p>
<img src="../etc/table_09.png" />
</p>

<h2>2. The Bond/Angle/Dihedral/Improper Table</h2>
<p>
The property table can also show other information. The type of information can be selected at the popup menu.
</p>
<p><img src="../etc/table_10.png" /></p>
<p>
The bond, angle, dihedral, and improper tables show the indices, names, and types of the constituent atoms. In addition, the quantities (bond lengths, angles, etc.) and the molecular mechanics parameters (only after MM/MD calculation is performed) are also shown.
</p>
<p><img src="../etc/table_11.png" /></p>
<p>
The bonds, angles, etc. are not editable in the property table. At present, the only way to create/delete bonds from GUI is to use the mouse operation "Bond" or "Erase".
</p>

<h2>3. The Parameter Table</h2>
<p>
The parameter table shows the molecular mechanics parameters in one table.
</p>
<p><img src="../etc/table_12.png" /></p>
<p>
When you build a molecule from scratch, and open the parameter table before doing any MM/MD operations, this table is likely to be empty. This is because the MM parameters are looked up only when "Molecular Dynamics..." or "Minimize..." menu command is invoked, or you use MM/MD tools like Antechamber (see Step 4 for details). After doing some of these operations, you will see a set of parameters shown in this table.
</p>
<p>
The parameters are grouped in several classes, namely "VDWs", "Bonds", "Angles", "Dihedrals", "Impropers", and "VDW Pairs".
</p>
<p>
The "VDWs" parameters are for the van der Waals nonbonding interaction, described by "eps" (the  energy at the potential minimum in kcal/mol), "r" (the van der Waals radius in &Aring;, which is half of the interatomic distance at the equilibrium state), "eps14", "r14" (eps and r for the pair of atoms separated by exactly three bonds. In many applications, the same parameters with the ordinary pair are used with a specific factor multiplied), "atomNo" (the atomic number), "weight" (the atomic weight). The last two are usually overridden by the atom parameters.
</p>
<p>
The "Bonds" parameters consist of "k" (the force constant in kcal/mol/&Aring;<sup>2</sup>) and "r0" (the equilibrium bond length). The "Angles" parameters consist of "k" (the force constant in kcal/mol/radian<sup>2</sup>) and "a0" (the equilibrium bond angle). The "Dihedrals" and "Impropers" parameters consist of "k" (the force constant in kcal/mol/radian<sup>2</sup>), "period" (the periodicity), and "phi0" (the equilibrium torsion angle in degree). The "VDW Pairs" parameters are (rarely) used to describe pair-specific van der Waals interactions, and consist of "eps", "r", "eps14", and "r14".
</p>
<p>
There is another important property for each parameter, that is, whether the parameter is taken from the "global" source (i.e. not specific to this molecule), or it is "local" (specific to this molecule), or "undefined". This property is shown by the color of the row. The global parameters are shown in white cells, the local ones in pale yellow, and the undefined ones in red.
</p>
<p><img src="../etc/table_13.png" /></p>
<p>
You can edit the parameters (although you need to be familiar with MM parameters and to know what you are doing!), but only if they are "local" or "undefined" parameters. The "global" parameters cannot be edited because it may be also used in other molecules, where the edited parameters may not be appropriate. If you want to modify some parameters but they are "global", then you can make them "local" by copying the parameters and the pasting.
</p>
<p><img src="../etc/table_14.png" /></p>
<p>
Another way to create a "local" parameter is to use the "Create New Parameter" menu command in the Edit menu. You can choose the parameter type in the submenu.
</p>
<p><img src="../etc/table_15.png" />
<img src="../etc/table_16.png" /></p>
<p>
If some parameters are not to be used for calculation, you can "cut" the parameters from the table. This feature is useful when you have many duplicated parameters having different force constants. (In actual calculation, the parameter appearing later in the table will be used.)
</p>

</div>
<div class="contents" lang="ja">
<h1>第五段階：分子を編集する：属性テーブルを使う</h1>
<h2>1. 分子の属性テーブル</h2>
<p>
分子はいろいろな属性を持っています。まず原子と結合があります。原子は名前、原子タイプ、元素、原子量（元素が決まれば決まる）、電荷、座標、など。また、生化学の習慣に従い、原子は「残基」でグループ化されています。分子はまた、分子力学のパラメータを持っています。Molby はまた量子化学計算も部分的にサポートします。それと関連して、分子に分子軌道係数などの情報を持たせることができます。
</p>
<p>
これらの情報の多くは「属性テーブル」で見ることができます。属性テーブルは、分子モデルのウィンドウの左半分にあります。
</p>
<p><img src="../etc/table_01.png" /></p>
<p>
図では、テーブルは原子の属性を表示しています。名前、原子タイプ、元素、残基名と残基番号、座標、部分電荷です。これらの属性はダブルクリックして編集することができます。
</p>
<p><img src="../etc/table_02.png" /></p>
<p>
リターン（エンター）またはタブキーを押すと、編集した値は確定され、別のセルが編集状態になります。リターン、シフト＋リターン、タブ、シフト＋タブでそれぞれ下・上・右・左のセルに移動します。編集を終了したい時は、オプション（Windows では Alt）＋リターンを使ってください。
</p>
<p>
いくつか注意点があります。
</p>
<p>
(1) 原子のインデックス（一番左の列）は編集できません。原子の順序を変えたい時は、下の図にあるように「ドラッグ・アンド・ドロップ」操作を使ってください。
</p>
<p><img src="../etc/table_03.png" />
<img src="../etc/table_04.png" /></p>
<p>
(2) 残基の列には、残基の名前と残基番号がピリオドでつないで表示されています。このセルを編集すると、妙なことが起きて驚くかもしれません。たとえば、原子０の残基名を "RES" から "XXX" に変えると、残基番号が "1" であるすべての原子の残基名が "XXX" に変わります。
</p>
<p><img src="../etc/table_05.png" />
<img src="../etc/table_06.png" /></p>
<p>
この挙動は、すべての残基名と残基番号は統一されていなければならない、という原理によります。つまり、同じ残基番号を持つ原子の残基名は同じでなければなりません。時にはこの挙動が便利に使えますが、混乱を招くことも多くあります。
</p>
<p>
残基名と残基番号を変更するお勧めの方法は、変更したい原子を選択して "Script" メニューの "Assign Residue..." コマンドを使うことです。
</p>
<p>
<img src="../etc/table_07.png" />
&nbsp;&nbsp;&nbsp;&nbsp;
<img src="../etc/table_08.png" />
</p>
<p>
<img src="../etc/table_09.png" />
</p>

<h2>2. Bond/Angle/Dihedral/Improper テーブル</h2>
<p>
属性テーブルは他の情報も表示することができます。テーブルの種類はポップアップメニューで選択できます。
</p>
<p><img src="../etc/table_10.png" /></p>
<p>
Bond, angle, dihedral, improper テーブルは、それぞれ結合・結合角・二面角・improper 二面角の構成原子のインデックス、名前、原子タイプを表示します。また、現在の値（結合長、角度、など）と、分子力学パラメータ（MM/MD 計算を行った直後に限られますが）も表示されます。
</p>
<p><img src="../etc/table_11.png" /></p>
<p>
このテーブルで、結合、結合角などを編集することはできません。現在、画面上のインターフェイスを使って結合を作ったり削除したりする唯一の方法は、"Bond", "Erase" のマウス操作を使うことです。
</p>

<h2>3. パラメータテーブル</h2>
<p>
パラメータテーブルは、分子力学パラメータを表示します。
</p>
<p><img src="../etc/table_12.png" /></p>
<p>
分子を新しく作成して、MM/MD に関連する操作を何もせずにパラメータテーブルを開くと、テーブルはおそらく空のままでしょう。分子力学パラメータは、"Molecular Dynamics..." または "Minimize..." メニューコマンドを実行したときか、Antechamber のような分子力学用ツール（第四段階参照）を使った時に初めて作成されます。これらの操作をした後には、パラメータがこのテーブルに表示されます。
</p>
<p>
パラメータはいくつかの種類にグループ分けされています。"VDWs", "Bonds", "Angles", "Dihedrals", "Impropers", そして "VDW Pairs" です。
</p>
<p>
"VDWs" パラメータは、van der Waals 相互作用のためのもので、必要な値は "eps"（ポテンシャル極小値、kcal/mol）、"r"（van der Waals 半径、&Aring;。ポテンシャル極小状態での原子間距離の 1/2）、"eps14", "r14"（結合３つで隔てられた２つの原子間の eps と r。多くの分子力学パッケージでは、通常の原子間と同じパラメータに一定の係数をかけて用いることが多い）、"atomNo"（原子番号）、"weight"（原子量）。最後の２つは、ふつうは各原子のパラメータで上書きされます。
</p>
<p>
"Bonds" パラメータは、"k"（結合の力の定数、kcal/mol/&Aring;<sup>2</sup>）、"r0"（平衡結合長さ、&Aring;）から成ります。"Angles" パラメータは、"k"（結合角の力の定数、kcal/mol/radian<sup>2</sup>）、"a0"（平衡結合角、degree）から成ります。'Dihedrals", "Impropers" パラメータは、"k"（力の定数、kcal/mol/radian<sup>2</sup>）、"period"（周期）、"phi0"（平衡二面角、degree）から成ります。"VDW Pairs" パラメータは滅多に使われませんが、ある原子の組み合わせに特有の van der Waals 相互作用を記述するもので、"eps", "r", "eps14", "r14" から成ります。
</p>
<p>
それぞれのパラメータにはもう一つ重要な特性があります。それは、そのパラメータが「グローバル」なのか（つまり、他の分子にも使われる共通の値なのか）、または「ローカル」なのか（この分子に特有）、または「未定義」なのか、です。この特性は、テーブルの行の色で区別できます。「グローバル」なパラメータは白、「ローカル」はうすい黄色、「未定義」は赤色のセルです。
</p>
<p><img src="../etc/table_13.png" /></p>
<p>
パラメータは編集することができます（あなたが分子力学パラメータに詳しくて、何をしているかわかっていればの話だけど！）。ただし、パラメータが「ローカル」「未定義」の場合だけです。「グローバル」パラメータは、他の分子でも使われている可能性があるため、編集できません。「グローバル」なパラメータを編集したい時は、そのパラメータをコピー・ペーストすることで「ローカル」パラメータにすることができます。
</p>
<p><img src="../etc/table_14.png" /></p>
<p>
「ローカル」なパラメータを作るもう１つの方法は、"Edit" メニューの "Create New Parameter" コマンドを使うことです。パラメータの種類をサブメニューから選ぶことができます。
</p>
<p><img src="../etc/table_15.png" />
<img src="../etc/table_16.png" /></p>
<p>
もしあるパラメータは計算に使わないという場合には、そのパラメータをテーブルから削除することができます。この機能は、同じパラメータで異なる値を持つものが複数ある場合に有用です。（実際の計算では、テーブルの後ろの方にあるパラメータが優先されます。）
</p>
</div>
<link id="#navigation" />
</div>

<div file="mm_minimize.html">
<link rel="Up" href="tutorials.html" />
<link rel="Prev" href="proptable.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>Step Six: Energy Minimization by Molecular Mechanics</h1>
<h2>1. About Molecular Mechanics Implementation in Molby</h2>
<p>
The molecular models built by hand generally include unnatural bond lengths, bond angles, van der Waals contacts, and so on. Molecular mechanics is a useful technique to remove such unnatural structures.
</p>
<p>
Molby implements molecular mechanics calculation by use of basic force fields, including bond stretching, angle bending, dihedral rotation, improper torsions, van der Waals interaction, and electrostatic interaction. With the exception of the electrostatic interaction, the parameters are taken from the predefined table by looking up the "atom types" assigned to the atoms.
</p>
<p>
By default, Molby uses <span class="italic">gaff</span> parameter set. Gaff, "General AMBER Force Field",   is a part of <a href="http://ambermd.org/">AMBER molecular dynamics package</a>; the force field parameters are made public domain by courtesy of the AMBER developers. Molby also includes <span class="italic">parm99</span> parameter set, another AMBER force field that is widely used for biomolecules.
</p>
<p>
The troublesome part in using force fields is how to assign atom types. The AMBER developers provides a useful set of programs to take care of this problem. Thanks again to the AMBER developers, these programs, named AmberTools, are now made public (open source under GPLv2). Molby includes some of these programs, and calls and imports the results.
</p>
<p>
Following are the original papers published by the AMBER team. Please be sure to refer to them in your publication when you use the AMBER parameters or AmberTools.
</p>
<ul>
<li>Wang, J.; Wolf, R.M.; Caldwell, J.W.; Kollamn, P.A.; Case, D.A. Development and testing of a general Amber force field. <span class="italic">J. Comput. Chem.,</span> <span class="bold">2004,</span> <span class="italic">25,</span> 1157–1174.</li>
<li>Wang, B.; Merz, K.M. Jr. A fast QM/MM (quantum mechanical/molecular mechanical) approach to calculate nuclear magnetic resonance chemical shifts for macromolecules. <span class="italic">J. Chem. Theory Comput.,</span> <span class="bold">2006,</span> <span class="italic">2,</span> 209–215. </li>
</ul>
<h2 id="minimize" name="minimize">2. Energy Minimization How-to</h2>
<p>
Now we try energy minimization. We use 2,2'-dimethoxybiphenyl as an example.
</p>
<p><img src="../etc/biphenyl.png" /> 2,2'-dimethoxybiphenyl</p>
<p>
Build this molecule. The easiest way is, (1) double-click the empty editing area and type "C6H5C6H5", (2) select one ortho hydrogen, double-click, and type "OCH3", (3) repeat (2) for another ortho hydrogen on the other ring.
</p>
<p><img src="../etc/minimize_01.png" /></p>
<p>
Open the "MM/MD" menu, and select "Guess MM/MD Parameters..." command.
</p>
<p><img src="../etc/minimize_02.png" /></p>
<p>
A dialog like below shows up. This is for execution of Antechamber on the current molecule. Turn off the "partial charge" checkbox. The "log" directory is used by AmberTools for storing intermediate files; the default value would be acceptable, but you can change it here.
</p>
<p><img src="../etc/minimize_03.png" /></p>
<p>
After pressing "OK", two dialog boxes appear in turn. They disappear so quickly that you may not recognize what they are saying; actually, the first one says "Running antechamber" and the second one "Running parmchk." These are programs included in AmberTools. In the present case, both programs complete successfully, and the following dialog appears.
</p>
<p><img src="../etc/minimize_04.png" /></p>
<p>
Press "OK", and you will return to the molecule window. Do you notice what change has been made? It is the atom types that are modified. Specifically, the types of the atoms 0 and 10 are changed from "ca" to "cp".
</p>
<p><img src="../etc/minimize_05.png" /></p>
<p>
If you are wondering what "ca" or "cp" mean, look at the global parameter table (MM/MD → View Global Parameters...), and find comment(s) in the "vdw" record.
</p>
<p><img src="../etc/minimize_06.png" /></p>
<p>
Return to the molecule, and select MM/MD → Minimize.
</p>
<p><img src="../etc/minimize_07.png" /></p>
<p>
A setting dialog opens. "Steps per frame" means the screen is updated every this number of steps. "Number of frames" means the maximum number of "frames" (i.e. screen updates) to calculate. If the minimization completes before this number of frames, the calculation will stop. The numbers 10 and 200 are reasonable choice in many cases.
</p>
<p><img src="../etc/minimize_08.png" /></p>
<p>
Press "OK", and minimization starts. As you expect, the dihedral angle between the two phenyl rings becomes large. The calculation will stop after 200 frames. You can see the number "200" at the right bottom of the window, and the slider at the bottom of the window is now active. Move the slider, and you can see how the molecular structure changed during the minimization.
</p>
<p><img src="../etc/minimize_09.png" /></p>
<p>
If you save this molecule at this stage, all the frames will be also saved (when you select the "mbsf" format), and the resulting file may be very large. If you do not want this, then you can remove all the frames by use of "Delete Frames..." command in the "Script" menu.
</p>
<p><img src="../etc/minimize_10.png" /></p>
<p><img src="../etc/minimize_11.png" /></p>
<h2 id="electrostatic" name="electrostatic">3. Handling electrostatic interaction</h2>
<p>
The above description is sufficient for initial cleanup of the molecular structure. However, we should go one further step to take electrostatic interaction into consideration. This is particularly important in molecules with polar functional groups (such as carbonyl).
</p>
<p>
Continue our study on 2,2'-dimethoxybiphenyl. Open "MM/MD" → "Guess MM/MD Parameters...", and this time turn on the top checkbox. Also make sure the net molecular charge is correct.
</p>
<p><img src="../etc/minimize_12.png" /></p>
<p>
Press "OK", and calculation starts. This time the calculation should take much longer than before, because semi-empirical calculation is carried out for optimizing the structure and getting the partial charges.
</p>
<p><img src="../etc/minimize_13.png" /></p>
<p>
When calculation is done, the molecular structure may change, because structure optimization has been done by semi-empirical calculation. However, even more important is the "charge" values. You can see the charge values by scrolling the table to the right. By use of these "charge" values, interaction energies of the polar functional groups can be taken into account.
</p>
<p><img src="../etc/minimize_14.png" /></p>
<p>
Note that the atomic charges given in the above method are derived from semi-empirical quantum chemical calculations. On the other hand, it is generally considered that the charges derived from ab initio calculations are better. Molby does not have capability to perform ab initio calculations, but it can help creating necessary input files for external quantum chemical programs. This will be described <a href="qchem.html#gamess_resp">elsewhere</a> in this User's Manual.
</p>
</div>

<div class="contents" lang="ja">
<h1>第六段階：分子力学計算によるエネルギー最小化</h1>
<h2>1. Molby の分子力学計算について</h2>
<p>
手作業で作成した分子モデルは、不自然な結合長、結合角、van der Waals 接触などを含んでいます。このような不自然な構造を修正するには、分子力学のテクニックが便利です。
</p>
<p>
Molby の分子力学計算は、基本的な分子力場（結合の伸縮、結合角のたわみ、二面角の回転、improper torsion、van der Waals 相互作用、静電相互作用）に基づいています。静電相互作用以外については、パラメータのセットが用意してあり、原子に与えられた「原子タイプ」から必要なパラメータを取り出して計算に使います。
</p>
<p>
デフォルトでは、Molby は <span class="italic">gaff</span> パラメータセットを使います。Gaff は "General AMBER Force Field" の略で、<a href="http://ambermd.org/">AMBER 分子動力学パッケージ</a>の一部です。AMBER 開発者の好意により、分子力場パラメータはパブリックドメインとされています。なお、Molby は <span class="italic">parm99</span> パラメータセットも同梱しています。これも AMBER の分子力場であり、生体分子の計算に広く使われています。
</p>
<p>
分子力場を使うときに厄介なのは、原子タイプをどうやって指定するかです。AMBER には、このための便利なプログラム AmberTools が含まれています。これもまた AMBER 開発者の好意により、AmberTools はフリーソフトウェア（GPLv2）として公開されています。Molby は AmberTools のプログラムの一部を同梱しています。
</p>
<p>
以下の論文は AMBER 開発チームによるものです。AMBER パラメータや AmberTools プログラムの機能を使った場合は、発表論文にこれらの論文を引用してください。
</p>
<ul>
<li>Wang, J.; Wolf, R.M.; Caldwell, J.W.; Kollamn, P.A.; Case, D.A. Development and testing of a general Amber force field. <span class="italic">J. Comput. Chem.,</span> <span class="bold">2004,</span> <span class="italic">25,</span> 1157–1174.</li>
<li>Wang, B.; Merz, K.M. Jr. A fast QM/MM (quantum mechanical/molecular mechanical) approach to calculate nuclear magnetic resonance chemical shifts for macromolecules. <span class="italic">J. Chem. Theory Comput.,</span> <span class="bold">2006,</span> <span class="italic">2,</span> 209–215. </li>
</ul>
<h2 id="minimize" name="minimize">2. エネルギー最小化の方法</h2>
<p>
さて、エネルギー最小化をやってみましょう。例として 2,2'-ジメトキシビフェニルを使うことにします。
</p>
<p><img src="../etc/biphenyl.png" /> 2,2'-ジメトキシビフェニル</p>
<p>
この分子のモデルを作ってください。簡単なやり方は、(1) 空の編集エリアでダブルクリックして "C6H5C6H5" とタイプする。(2) オルト位の水素原子を１つ選択し、ダブルクリックして "OCH3" とタイプする。(3) もう１つの環のオルト位の水素原子について、(2) を繰り返す。
</p>
<p><img src="../etc/minimize_01.png" /></p>
<p>
"MM/MD"メニューを開き、"Guess MM/MD Parameters..." コマンドを実行します。
</p>
<p><img src="../etc/minimize_02.png" /></p>
<p>
下のようなダイアログが現れます。これは現在の分子に対して Antechamber を実行するためのものです。一番上のチェックボックス (partial charge) をオフにしてください。"Log" ディレクトリは、AmberTools のプログラムが中間ファイルを保存するのに使います。デフォルトの位置で問題はないでしょうが、変更してもかまいません。
</p>
<p><img src="../etc/minimize_03.png" /></p>
<p>
"OK"を押すと、２つのダイアログが順に現れます。すぐに消えてしまうので、何と書いてあるか読めないかも知れません。最初のものは "Running antechamber", ２つめのものは "Running parmchk" と書いてあります。これらは AmberTools に含まれているプログラムです。今の場合は、両方とも正しく実行され、次のダイアログが現れます。
</p>
<p><img src="../etc/minimize_04.png" /></p>
<p>
"OK"を押して、分子のウィンドウに戻ってください。何が変わったかわかるでしょうか？　変わったのは原子タイプです。具体的には、原子０と原子１０のタイプが "ca" から "cp" に変わっています。
</p>
<p><img src="../etc/minimize_05.png" /></p>
<p>
"ca" や "cp" が何の意味か知りたければ、"MM/MD" メニューから "View Global Parameters..." を選んでみてください。Molby に同梱されているパラメータの一覧表が出てきます。"vdw" （van der Waals パラメータの意味ですが、原子タイプの定義も兼ねています）の中で "ca", "cp" を見つけて、表の右端にあるコメントを見てみてください。
</p>
<p><img src="../etc/minimize_06.png" /></p>
<p>
分子のウィンドウに戻り、"MM/MD" → "Minimize" を選んでください。
</p>
<p><img src="../etc/minimize_07.png" /></p>
<p>
設定ダイアログが開きます。"Steps per frame" は、構造最適化計算がこのステップ数進んだところで画面を更新する、という意味です。"Number of frames" は、この数だけ画面を更新したら計算を止める、という意味です。その前に構造最適化が終了すれば、その時点で計算は止まります。下の図にある 10, 200 を入れておけば、たいていの場合はよいでしょう。
</p>
<p><img src="../etc/minimize_08.png" /></p>
<p>
"OK" を押すと、構造最適化が始まります。この分子の場合、期待される通り、２つのベンゼン環の間の二面角がだんだん大きくなります。指定通り、200回画面が更新されると計算は止まります。ウィンドウの右下に "200" という数字があり、ウィンドウの下辺にあるスライダーが有効になっています。更新された画面は、それぞれ独立したフレームとして保存されており、このスライダーを動かすと、初期状態からどのように構造が変わって行くかを再現することができます。
</p>
<p><img src="../etc/minimize_09.png" /></p>
<p>
この時点で分子を "mbsf" フォーマットで保存すると、全部のフレームの情報が保存され、ファイルがとても大きくなります。これが好ましくない場合は、現在表示されている以外のフレームを削除することもできます。"Script" メニューから "Delete Frames..." コマンドを使ってください。
</p>
<p><img src="../etc/minimize_10.png" /></p>
<p><img src="../etc/minimize_11.png" /></p>
<h2 id="electrostatic" name="electrostatic">3. 静電相互作用の取り扱い</h2>
<p>
上の説明は、分子構造のひずみを取り除く最初の段階としては十分です。しかしながら、次の段階として、静電相互作用を考慮しなければなりません。特に、カルボニル基などの極性官能基が含まれている場合は、これは重要です。
</p>
<p>
2,2'-ジメトキシビフェニルについて検討を続けましょう。"MM/MD" → "Guess MM/MD Parameters...", を開き、今度は一番上のチェックボックスをオンにします。そして、分子の総電荷が正しいことを確認してください。この場合は中性分子なので、"0" で結構です。
</p>
<p><img src="../etc/minimize_12.png" /></p>
<p>
"OK" を押すと、計算が始まります。今度は、前回よりもずっと長く計算時間がかかります。半経験的分子軌道法により、構造最適化と部分電荷の計算を行うからです。
</p>
<p><img src="../etc/minimize_13.png" /></p>
<p>
計算が終了すると、分子構造は少し変化することがあります。半経験的分子軌道計算で構造最適化が行われたからです。また、"charge" の値が設定されていることがわかります。テーブルを右にスクロールすると、与えられた電荷の値を見ることができます。この電荷の値を用いて静電相互作用の計算を行うことにより、極性官能基の相互作用エネルギーをより正しく見積もることができます。
</p>
<p><img src="../etc/minimize_14.png" /></p>
<p>
上の方法で計算した電荷は、半経験的分子軌道計算によるものです。一方、一般的には ab initio 計算で求めた電荷の方が良いと考えられています。Molby は ab initio 計算を行う機能を持っていませんが、外部の量子化学計算プログラムへの入力ファイルを作成する機能があります。これは、このマニュアルの<a href="qchem.html#gamess_resp">別のところ</a>で解説します。
</p>

</div>
<link id="#navigation" />
</div>

<div file="md.html">
<link rel="Up" href="tutorials.html" />
<link rel="Prev" href="mm_minimize.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>Step Seven: Molecular Dynamics (MD) Calculation</h1>
<h2>1. MD Calculation within Molby</h2>
<p>
Molby implements molecular dynamics (MD) calculation which uses the same force fields as the energy minimization by molecular mechanics (MM). This implementation is suitable only for preliminary calculations (to check parameters quickly, etc.); for production runs, it is strongly recommended that you use one of the established software packages.
</p>
<p>
An example of preliminary MD run is presented here. We use 2,2'-dimethoxybiphenyl again. In a similar way as in the <a href="mm_minimize.html">step six</a>, create a model and assign MM parameters (including the partial charges on the atoms).
</p>
<p><img src="../etc/tutorial_7_01.png" /></p>
<p>
Select MM/MD &rarr; Molecular Dynamics. A setting dialog opens. Although this dialog resembles that in MM minimization, it shows different parameters that are relevant to the MD calculation.
</p>
<p><img src="../etc/tutorial_7_02.png" /></p>
<p>
The "timestep" parameter defines the minimum time increment in solving the equation of motions. The "target temperature" defines the temperature of the system. Before running the MD calculation, all atoms are let to have random velocities with the Boltzmann distribution corresponding to the target temperature. In addition, the velocities are modified so that the temperature is kept constant. The "steps per frame" and "number of frames" parameters have the same meaning as in the MM minimization. The screenshot shows 10 as the "steps per frame"; this is an appropriate value for MM minimization, however for MD calculations a larger value would be more appropriate (like 100). 
</p>
<p>
Pressing the "Advanced..." button opens another dialog with other parameters. The meanings of the parameters are described in the embedded Ruby document, in the <a href="molby_rb/MDArena.html">MDArena</a> page.
</p>
<p><img src="../etc/tutorial_7_03.png" /></p>
<p>
Return to the original MD dialog (by pressing "Close" in the advanced settings dialog), and press "OK". The MD run starts, and new frames are accumulated. If you find something is wrong, or want to stop before getting the specified number of frames, you can stop the MD run by pressing Command-period (Mac) or Control-period (Windows).
</p>
<h2>2. Using Molby with AMBER: Creating Inputs and Importing Outputs</h2>
<p>
For production runs, you can create AMBER input files from Molby. More specifically, you can create "prmtop" and "inpcrd" files for the SANDER module.
</p>
<p class="note">
<span class="italic">Note:</span> There is no guarantee that Molby creates the exactly same input as the official AMBER modeling tools, nor the generated files are valid inputs for the SANDER module. You may need to modify them by hand.
</p>
<p>
To creat SANDER input files, select "Create SANDER input..." command in the "MM/MD" &rarr; "Tools" submenu.
</p>
<p><img src="../etc/tutorial_7_04.png" /></p>
<p>
You will be asked first for the file name for the "prmtop" file. Please be sure to add ".prmtop" extension. The other file, "inpcrd" file, is created as the same name with the ".prmtop" extension replaced by the ".inpcrd" extension.
</p>
<p><img src="../etc/tutorial_7_05.png" /></p>
<p>
Subsequently, you will be asked to select one of the two versions of the prmtop files. The older one, "AMBER8/NAMD", allows you to use the output file by NAMD (see below).
</p>
<p><img src="../etc/tutorial_7_06.png" /></p>
<p>
Now you can transfer your files to the workstation running SANDER. To perform the simulation, you still need to create the instruction file for SANDER, which you should already know if you are using AMBER.
</p>
<p>
After the simulation is over, you can get the trajectory file ("mdcrd" file) back and import to Molby. Use "Import..." command in the "File" menu, select "AMBER mdcrd file (*.crd; *.mdcrd)", and specify the file.
</p>
<p><img src="../etc/tutorial_7_07.png" /></p>
<h2>3. Using Molby with NAMD: Creating Inputs and Importing Outputs</h2>
<p>
You can also use the NAMD software package for production run. NAMD is developed by the Theoretical Biophysics Group in the University of Illinois at Urbana-Champaign, and the official information is found at their web site (<a href="http://www.ks.uiuc.edu/Research/namd/">http://www.ks.uiuc.edu/Research/namd/</a>). NAMD can use the AMBER "prmtop" as the input, by use of the instruction <code>amber yes</code>. See NAMD Users' Guide for details.
</p>
<p>
You can also import the NAMD output by importing the dcd file. The file format is also listed in the "Import..." file dialog.
</p>
<h2>4. Building Solvated Structures</h2>
<p>
When you want to perform MD simulations in explicit solvent, you need to build a box of solvent molecules around the target molecule. Molby can help creating solvated structures.
</p>
<p>
To build a solvated structure, you need to open the file containing the predefined box of the desired solvent. The following solvent box is included in the Molby package, and can be accessed from "File" &rarr; "Open Predefined" &rarr; "Solvent boxes" submenu. The tip3box was taken from the AmberTool package, and other solvent boxes were taken from <a href="http://www.pharmacy.manchester.ac.uk/bryce/amber">Amber parameter database</a>.
</p>
<table border="1" cellspacing="0">
<tr><th>name</th><th>solvent</th><th>reference</th></tr>
<tr><td>tip3pbox</td>
<td>water</td>
<td>Jorgensen, W. L.; Chandrasekhar, J.; Madura, J.; Klein, M. L.<br />
J. Chem. Phys. 1983, 79, 926–935.
</td></tr>
<tr><td>chcl3box</td>
<td>chloroform</td>
<td>Cieplak, P.; Caldwell, J. W.; Kollman, P. A.<br />
J. Comp. Chem. 2001, 22, 1048<br />
</td></tr>
<tr><td>dmsobox</td>
<td>dimethylsulfoxide</td>
<td>Fox, T.; Kollman, P. A.<br />
J. Phys. Chem. B 1998, 102, 8070.
</td></tr>
<tr><td>meohbox</td>
<td>methanol</td>
<td>Caldwell, J. W.; Kollman, P. A.<br />
J. Phys. Chem. 1995, 99, 6208.
</td></tr>
<tr><td>nmabox</td>
<td>N-methylacetamide</td>
<td>Caldwell, J. W.; Kollman, P. A.<br />
J. Phys. Chem. 1995, 99, 6208.
</td></tr>
</table>
<p><img src="../etc/tutorial_7_08.png" /><img src="../etc/tutorial_7_09.png" /></p>
<p>
While keeping the solvent box open, create or open the target (solute) molecule in a separate window. With this solute molecule in the front window, select "Solvate..." command from the "Script" menu. A dialog box opens.
</p>
<p><img src="../etc/tutorial_7_10.png" /></p>
<p>
In the popup menu "Choose solvent box:", you will find the solvent box you opened earlier. Note that this popup menu lists <span class="italic">all</span> open molecules that have the associated periodic box (or unit cell). This can lead to a confusing situation that, if you have another solvated structure also open, that structure will also be listed in this popup menu, because a solvated structure always have a periodic box. Therefore, please take care so that you choose the right solvent box.</p>
<p class="note">
If you open the solvent box from the "Open Predefined" menu, you can easily recognize it in the popup menu, because the name has asterisks at the beginning and the end, like "*CHCl3*".
</p>
<p>
The "Box offset" parameters define the thickness of the solvent layer surrounding the solute molecule. More specifically, the periodic box of the solvated structure is determined as follows: the minimum cuboid that can surround the solute molecule is defined, and all the faces are offset by the "Box offset" distances to the outside direction. On the other hand, it is possible to define the size of the periodic box explicitly for any of the three (x, y, z) directions. If you wish to do this, give a negative number for that direction. (For example, if you want the periodic box to be 40 &Aring; in the x direction, give -40 as the first "Box offset" parameter.)
</p>
<p class="note">
The size of the periodic box can be checked by selecting "MM/MD" &rarr; "Define Unit Cell" menu command.
</p>
<p>
The "Exclusion limit distance" defines the minimum allowed distance between the solvent and solute molecules. The solvent molecule is removed when it has atoms with smaller distances than this parameter from the solute molecule.
</p>

</div>
<div class="contents" lang="ja">
<h1>第七段階：分子動力学計算</h1>
<h2>1. Molby 組み込みの分子動力学 (MD) 計算</h2>
<p>
Molby は分子動力学 (MD) 計算を実装しています。これは分子力学によるエネルギー最小化と同じ分子力場を使います。この機能は、パラメータのチェックなどの予備的な計算に使うことを想定しています。本格的な計算には、実績のある他のソフトウェアパッケージを使うことを強くおすすめします。
</p>
<p>
予備的な MD 計算の例を示します。また 2,2'-ジメトキシビフェニルを使います。<a href="mm_minimize.html">第六段階</a>と同様に、モデルを作成して分子力場パラメータを決定してください（原子上の部分電荷も）。
</p>
<p><img src="../etc/tutorial_7_01.png" /></p>
<p>
MM/MD メニューの "Molecular Dynamics" を選ぶと、設定ダイアログが開きます。このダイアログは分子力場によるエネルギー最小化の時と似ていますが、MD 計算に使う他のパラメータを表示しています。
</p>
<p><img src="../etc/tutorial_7_02.png" /></p>
<p>
"Timestep" パラメータは、運動方程式を解くときの最小時間刻みを表します。"Target temperature" は系の温度を表します。MD 計算が始まる際に、すべての原子はこの温度に対応するボルツマン分布に従ってランダムな速度を与えられます。さらに、MD 計算中は温度が一定に保たれるように速度が調整されます。"Steps per frame" と "number of frames" パラメータは分子力学によるエネルギー最小化の時と同じ意味を持ちます。このスクリーンショットでは "steps per frame" が 10 になっています。これはエネルギー最小化では適切な値ですが、分子動力学の場合はもう少し大きな値（たとえば 100）の方がより適切です。
</p>
<p>
"Advanced..." ボタンを押すと、他のパラメータを持つ別のダイアログが開きます。これらのパラメータの意味は、内蔵 Ruby インタプリタのリファレンスで <a href="molby_rb/MDArena.html">MDArena</a> のページに書かれています。 
</p>
<p><img src="../etc/tutorial_7_03.png" /></p>
<p>
元の MD 設定ダイアログに戻り（詳細設定ダイアログで "Close" ボタンを押す）、"OK" を押します。MD 計算が始まり、新しいフレームが追加されて行きます。何か問題があったり、指定したフレーム数よりも前に計算を止めたいときは、コマンド-ピリオド (Mac) かコントロール-ピリオド (Windows) を使ってください。
</p>
<h2>2. AMBER とともに使う：入力の作成と出力結果のインポート</h2>
<p>
本格的な計算を行うために、Molby で AMBER への入力ファイルを作成することができます。具体的には、SANDER モジュールの入力となる "prmtop" と "inpcrd" ファイルを作ることができます。
</p>
<p class="note">
<span class="italic">注：</span> Molby が AMBER 付属のモデリングツールと同じ入力ファイルを作成する保証はありませんし、SANDER モジュールへの正しい入力になっている保証もありません。手作業で修正が必要な場合もあるかもしれません。
</p>
<p>
SANDER の入力ファイルを作るには、"MM/MD" &rarr; "Tools" サブメニューから "Create SANDER input..." コマンドを選んでください。
</p>
<p><img src="../etc/tutorial_7_04.png" /></p>
<p>
最初に "prmtop" ファイルの名前を聞かれます。必ず ".prmtop" 拡張子をつけるようにしてください。もう一つの "inpcrd" ファイルは、".prmtop" を ".inpcrd" に置き換えた名前で保存されます。
</p>
<p><img src="../etc/tutorial_7_05.png" /></p>
<p>
次に、prmtop ファイルの２つのバージョンのうち１つを選ぶように促されます。古い方、"AMBER8/NAMD" を使えば、NAMD ソフトウェアパッケージ（下記参照）でも使える入力ファイルができます。
</p>
<p><img src="../etc/tutorial_7_06.png" /></p>
<p>
これで、SANDER が走るワークステーションにファイルを転送することができます。シミュレーションを実行するためには、SANDER の命令ファイルを作らなければなりませんが、AMBER をお使いの方ならやり方はよくご存知でしょう。
</p>
<p>
計算が終了したら、トラジェクトリファイル ("mdcrd" ファイル) を取得して、Molby にインポートすることができます。"File" メニューの "Import..." コマンドを選び、ファイルタイプとして "AMBER mdcrd file (*.crd; *.mdcrd)" を選んで、ファイルを読み込んでください。
</p>
<p><img src="../etc/tutorial_7_07.png" /></p>
<h2>3. NAMD とともに使う：入力の作成と出力結果のインポート</h2>
<p>
本格的な計算を行うために NAMD を使うこともできます。NAMD はイリノイ大学アーバナ・シャンペーン校の理論生物物理グループが開発したソフトウェアパッケージです。公式ウェブサイトは <a href="http://www.ks.uiuc.edu/Research/namd/">http://www.ks.uiuc.edu/Research/namd/</a> です。NAMD は AMBER の "prmtop" を入力として使うことができます（<code>amber yes</code> 命令を使う）。詳しくは NAMD のユーザーズガイドをご覧ください。
</p>
<p>
NAMD の出力の dcd ファイルもインポートが可能です。"Import..." コマンドのファイルタイプで選択することができます。
</p>
<h2>4. 溶媒和構造の作成</h2>
<p>
明示的な溶媒中での MD シミュレーションを行うためには、目的分子の回りに溶媒分子の箱を作る必要があります。Molby でこのような溶媒和構造を作成することができます。
</p>
<p>
溶媒和構造を作るためには、まず使用する溶媒の箱を読み込む必要があります。以下の溶媒の箱が Molby に同梱されており、"File" &rarr; "Open Predefined" &rarr; "Solvent boxes" サブメニューから選ぶことができます。Tip3box は AmberTool パッケージから得たものであり、他の溶媒箱は <a href="http://www.pharmacy.manchester.ac.uk/bryce/amber">Amber parameter database</a> で公開されているものです。
</p>
<table border="1" cellspacing="0">
<tr><th>name</th><th>solvent</th><th>reference</th></tr>
<tr><td>tip3pbox</td>
<td>water</td>
<td>Jorgensen, W. L.; Chandrasekhar, J.; Madura, J.; Klein, M. L.<br />
J. Chem. Phys. 1983, 79, 926–935.
</td></tr>
<tr><td>chcl3box</td>
<td>chloroform</td>
<td>Cieplak, P.; Caldwell, J. W.; Kollman, P. A.<br />
J. Comp. Chem. 2001, 22, 1048<br />
</td></tr>
<tr><td>dmsobox</td>
<td>dimethylsulfoxide</td>
<td>Fox, T.; Kollman, P. A.<br />
J. Phys. Chem. B 1998, 102, 8070.
</td></tr>
<tr><td>meohbox</td>
<td>methanol</td>
<td>Caldwell, J. W.; Kollman, P. A.<br />
J. Phys. Chem. 1995, 99, 6208.
</td></tr>
<tr><td>nmabox</td>
<td>N-methylacetamide</td>
<td>Caldwell, J. W.; Kollman, P. A.<br />
J. Phys. Chem. 1995, 99, 6208.
</td></tr>
</table>
<p><img src="../etc/tutorial_7_08.png" /><img src="../etc/tutorial_7_09.png" /></p>
<p>
溶媒箱を開いたまま、目的とする分子（溶質）を新しいウィンドウで開くか作成します。溶質分子のウィンドウを最前面にした状態で、"Script" メニューから "Solvate..." コマンドを選びます。ダイアログが開きます。
</p>
<p><img src="../etc/tutorial_7_10.png" /></p>
<p>
ポップアップメニュー "Choose solvent box:" には、さきほど開いた溶媒箱がリストされているはずです。注意していただきたいのは、このポップアップメニューには周期境界（または単位格子）を持つすべての分子がリストされることです。このため、紛らわしいことに、別の溶媒和構造を同時に開いていると、その構造もこのポップアップメニューに登場してしまいます（溶媒和構造は必ず周期境界を持っていますから）。ですから、正しい溶媒箱を選ぶように十分に注意してください。
</p>
<p class="note">
"Open Predefined" メニューから選んで開いた溶媒箱はすぐに区別できます。名前の前後に * がついているからです ("*CHCl3*" のように）。
</p>
<p>
"Box offset" パラメータは、溶質分子の回りを囲む溶媒層の厚さを指定します。言い換えると、これから作成する溶媒和構造の周期境界は次のように決められます：まず溶質を囲む最小の直方体を算出し、それぞれの面を外側に向かって Box offsect パラメータ分だけ移動させます。一方、x, y, z のそれぞれの方向に対して、周期境界の大きさを決めたい場合もあります。このときは、その方向の Box offset パラメータに負の値を指定してください。（たとえば、x 方向の周期境界を大きさを 40 &Aring; にしたい時は、"Box offset" の最初のパラメータを -40 にしてください。）
</p>
<p class="note">
周期境界の箱の大きさは、"MM/MD" &rarr; "Define Unit Cell" メニューを選ぶと見ることができます。</p>
<p>
"Exclusion limit distance" は、溶質分子と溶媒分子の原子間距離の最小値を定めます。溶媒分子のある原子が溶質分子からこの距離以内に近づいているとき、その溶媒分子は取り除かれます。
</p>
</div>
<link id="#navigation" />
</div>

<div file="coordination.html">
<link rel="Up" href="tutorials.html" />
<link rel="Prev" href="md.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>Step Eight: MM/MD Calculation of Coordination Compounds</h1>
<h2>1. Use of UFF (Universal Force Field) Parameters</h2>
<p>
Building molecular models of coordination compounds is often problematic. This is mainly due to the lack of appropriate MM parameters for metal atoms. One reasonable approach is to use UFF (universal force field) parameters developed by Rappé and coworkers (<i>J. Am. Chem. Soc.</i> <b>114</b>, 10024-10035 (1992)). Although estimation of the UFF parameters from the molecular structure is rather complicated, it can be automated by computer programs. In the following, you will see how Molby can help modeling of coordination compounds with the UFF parameters.
</p>
<p>
Suppose we want to build a model of (terpy)PtCl, where terpy is 2,2':6',2"-terpyridine.
</p>
<p><img src="../etc/coord_01.png" /></p>
<p>
We need to build the molecular structure first. One approach is to build the organic part, and put metal atoms afterwards. Here, we will go through another route, which is more suitable for coordination compounds in general.
</p>
<p>
Select "Open Predefined..." menu item, and find "MX4 square-planar" like below.
</p>
<p><img src="../etc/coord_02.png" /></p>
<p>
A square planar fragment of "CuCl4" appears on the screen.
</p>
<p><img src="../etc/coord_03.png" /></p>
<p>
Choose the "Select" tool, double click on one of the chlorine atoms, and type "C6H5".
</p>
<p><img style="vertical-align:top;" src="../etc/coord_04.png" /><img src="../etc/coord_05.png" /></p>
<p>
You see now a phenyl group is attached to the metal atom. Select the metal-C bond, and rotate the phenyl ring so that the ring is approximately coplanar with the metal-ligand plane.
</p>
<p><img src="../etc/coord_06.png" /></p>
<p>
Attach two other phenyl groups in a similay manner.
</p>
<p><img src="../etc/coord_07.png" /></p>
<p>
Remove the hydrogen atoms and create C-C bonds. Double-click on the carbon atoms connected to the metal, and change them to "N".
</p>
<p><img style="vertical-align:top;" src="../etc/coord_08.png" /><img style="vertical-align:top;" src="../etc/coord_09.png" /><img src="../etc/coord_10.png" /></p>
<p>
Now the molecular structure is complete. Next we need to assign the MM parameters. To do this, select the "Guess UFF Parameters..." from the "MM/MD" menu.
</p>
<p><img src="../etc/coord_11.png" /></p>
<p>
A dialog like below opens up. Here are listed the atoms that are (1) the metal atoms, (2) the ligand atoms that are connected to the metal atoms, and (3) the ligand atoms that are connected to any of the atoms in (2). In other words, the atoms within "two-bonds" distances are shown in this dialog. The Pt atom is shown in red, because it does not have predefined MM parameters. The ligand atoms already have their MM parameters, but if you look closely not all atoms are correctly recognized. For example, the pyridine N atoms are incorrectly assigned as "n3", which is a sp3 nitrogen.
</p>
<p><img src="../etc/coord_12.png" /></p>
<p>
The UFF parameter estimation consists of two stages. The first stage is to assign the types of the ligand atoms. This is basically the same as the procedure described in <a href="mm_minimize.html">Step 6</a>, but this time we need to run Antechamber for the non-metal part only. By hitting the button "Run Antechamber for Non-Metal Fragment", Antechamber is executed for each non-metal fragments. You may need to assign the charge for each fragment; for example, if you are using catecholato ligand, that fragment should have charge of -2.
</p>
<p><img style="vertical-align:top;" src="../etc/coord_13.png" /><img src="../etc/coord_14.png" /></p>
<p>
The fragment that are being assigned by Antechamber is shown in the main window as the selection. In this example, the first fragment contains only the chlorine atom, and the second fragment is the terpyridine ligand.
</p>
<p><img src="../etc/coord_15.png" /><img src="../etc/coord_16.png" /></p>
<p>
After running Antechamber, the table looks like below. Note that the values in the "type" column have been changed.
</p>
<p><img src="../etc/coord_17.png" /></p>
<p>
Next, we need to assign the "UFF types" to each atoms. In fact, the UFF types are already set in the previous stage. We still need to look at them, and correct the types if necessary. You can select the predefined UFF types from the popup menu.
</p>
<p><img src="../etc/coord_18.png" /></p>
<p>
One more step before estimating the UFF parameters. Click on the "Bonds" button, and the bond length table is shown as below.
</p>
<p><img src="../etc/coord_19.png" /></p>
<p>
Look at the rightmost two columns, named "r0" and "real_r". The value "r0" is the equilibrium bond length, and "real_r" is the present bond length. You see that "r0" is 0.000 for Pt-Cl and Pt-N bonds. If you do not give values, then the values in the "real_r" column are used. Apparently these bond lengths are too small, so we correct the "r0" values. Appropriate values would be 2.30 for Pt-Cl and 2.00 for Pt-N. If you have other favorite values based on your experience, please feel free to use them.
</p>
<p><img src="../etc/coord_20.png" /></p>
<p>
You can check the "Angles" page as well. In this case, all values can be left as 0.0.
</p>
<p><img src="../etc/coord_21.png" /></p>
<p>
Now you can hit the "Guess UFF Parameters for Bonds..." button. Make sure that the "k" and "a0" values are now set. Look at the "Bonds" and "Atoms" pages as well and see how the parameters are changed.
</p>
<p><img src="../etc/coord_22.png" /></p>
<p>
Close this dialog, and go into MM/MD calculations as usual. For example, you can perform energy minimization and get the structure like below.
</p>
<p><img src="../etc/coord_23.png" /></p>
<h2>2. Compounds Containing Metal-π Bonds</h2>
<p>
Compounds containing metal-π bonds are also problematic in molecular mechanics calculations. The implementation of metal-π bonds in Molby is based on the proposal by Doman and coworkers (<i>J. Am. Chem. Soc.</i> <b>114,</b> 7262-7272 (1992)). Herein we will see how to build a molecular model of ferrocene.
</p>
<p><img src="../etc/ferro_01.png" /></p>
<p>
We start with the predefined structure "cyclopentadienyl."
</p>
<p><img src="../etc/ferro_02.png" /><img src="../etc/ferro_03.png" /></p>
<p>
Select the five carbon atoms, and do "Create Pi Anchor" menu command.
</p>
<p><img src="../etc/ferro_04.png" /></p>
<p>
"Pi anchor" is a <i>virtual atom</i>, whose coordinates are defined as the center of mass of the "parent" atoms. In this case, the parent atoms of the pi anchor is the carbon atoms of the Cp ring. In the main screen, the pi anchor is shown as a green dot, and it is connected to the parent atoms by a green thin bonds.
</p>
<p><img src="../etc/ferro_05.png" /></p>
<p>
Rotate the ring to show the "side view" of the ring, while keeping the pi anchor barely visible. Create a bond from the pi anchor to a new atom. Change the new atom to Fe.
</p>
<p><img src="../etc/ferro_06.png" /><img src="../etc/ferro_07.png" /><img src="../etc/ferro_08.png" /></p>
<p>
Copy the cyclopentadienyl ring and the pi anchor, and paste in the same window. Place the new ring to the appropriate position, and bond the Fe atom and the new pi anchor.
</p>
<p><img src="../etc/ferro_09.png" /><img src="../etc/ferro_10.png" /><img src="../etc/ferro_11.png" /></p>
<p>
Finally, make a bond between the two pi anchors. This is necessary to describe the barrier for ring rotation. The anchor-anchor bond is shown as a half-transparent green stick.
</p>
<p class="note">The ring rotation can be described as a dihedral term in the form of "ring atom"-"pi anchor"-"metal"-"X". However, in the case of a linear metallocene, "X" is the other pi anchor. Since the "pi anchor"-"metal"-"pi anchor" angle is always close to 180 degree, the dihedral angle cannot be defined. For this reason, the linear metallocene requires special treatment of the dihedral term in the form of "ring atom"-"pi anchor"-"pi anchor"-"ring atom". That is why we need to make a bond between two pi anchors. This is not the case for the bent metallocenes (like Cp<sub>2</sub>TiCl<sub>2</sub>), or half-sandwich complexes.
</p>
<p><img src="../etc/ferro_12.png" /></p>
<p>
Now we can go on to the UFF dialog as before. This time, we skip the "non-metal fragments" part, because Antechamber cannot handle cyclopentadienyl anion. Our cyclopentadienyl ring already has correct atom types, so we will use them as they are.
</p>
<p>
Change the UFF type of the Fe atom to "Fe2+ octahedral".
</p>
<p><img src="../etc/ferro_13.png" /></p>
<p>
Click on the "Bonds" label, and change the "r0" parameter of the two bonds of "##-fe" or "fe-##" type ("##" represents the pi anchor). This should be the metal-pi distance, which is 1.66 &Aring; for ferrocene.
</p>
<p><img src="../etc/ferro_14.png" /></p>
<p>
The "Angle" page should also be edited. The "a0" parameter is set to 90.0 for the "fe-##-ca" type angles (ten lines from the top), and 180.0 for the "##-fe-##" type angle (the last line).
</p>
<p><img src="../etc/ferro_15.png" /></p>
<p>
Hit the "Guess UFF Parameters..." button to complete the calculation of the UFF parameters.
</p>
<p><img src="../etc/ferro_16.png" /></p>
<p>
You can now try the MM/MD calculation. Energy minimization results in an eclipsed conformation. MD at 298K shows that the Cp rings freely rotate at this temperature.
</p>
<p><img src="../etc/ferro_17.png" /></p>
</div>
<div class="contents" lang="ja">
<h1>第八段階：配位化合物のMM/MD計算</h1>
</div>
<link id="#navigation" />
</div>

<div file="qchem.html">
<link rel="Up" href="tutorials.html" />
<link rel="Prev" href="coordination.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>Step Nine: Collaboration with Other Quantum Chemistry Softwares</h1>
<p>
Molby has a capability to export and import files for quantum chemistry softwares, namely <a href="http://www.gaussian.com/">Gaussian</a> and <a href="http://www.msg.ameslab.gov/GAMESS/">GAMESS</a>. At present, the capability is quite limited, and in many cases it would be much better to use other established softwares. Nevertheless, if you are already familiar with Molby, you may want to use Molby for creating input files for Gaussian and GAMESS and processing outputs. Here are instructions how to do it.
</p>
<p class="note">
Needless to say, you need to have access to Gaussian or GAMESS program packages. They can be on the same machine or on other machines (workstations) than Molby. Please learn how to use these packages before using Molby as described in this section.
</p>
<h2>1. Using Gaussian</h2>
<p>
The Gaussian input can be created by selecting "Export..." command in the "File" menu. The file extension is either "gjf" (as is the convention in GaussianW) or "com" (as in UNIX version of Gaussian).
</p>
<p><img style="vertical-align:top;" src="../etc/tutorial_8_01.png" /><img src="../etc/tutorial_8_02.png" /></p>
<p>
The output will look like this. Although Molby can create only one type of Gaussian input (optimize with PM3), it should be relatively easy to modify the generated input file by hand.
</p>
<p class="code">%Chk=benzene.chk
# PM3 Opt

 unnamed1; created by Molby at Sat Feb 11 00:30:21 +0900 2012

 0 1
C       -0.653000   0.585000  -1.068000
H       -1.158000   1.039000  -1.898000
C        0.729000   0.607000  -1.003000
H        1.295000   1.076000  -1.783000
C        1.382000   0.021000   0.069000
H        2.452000   0.038000   0.119000
C        0.651000  -0.586000   1.076000
H        1.156000  -1.039000   1.906000
C       -0.732000  -0.607000   1.012000
H       -1.298000  -1.077000   1.792000
C       -1.384000  -0.021000  -0.060000
H       -2.455000  -0.038000  -0.110000

</p>
<p>
When you do geometrical optimization, you may want to examine how the structure changes as the calculation proceeds. This can be done by importing the Gaussian output file. The extention should be either ".out" or ".log".
</p>
<p><img style="vertical-align:top;" src="../etc/tutorial_8_03.png" /><img src="../etc/tutorial_8_04.png" /></p>
<h2>2. Using GAMESS</h2>
<p>
Creating GAMESS input can be more complicated than Gaussian, so that Molby provides a simple dialog to help creating GAMESS input. The dialog is accessible from the "Creating GAMESS input..." command in the "QChem" menu.
</p>
<p><img src="../etc/tutorial_8_05.png" /></p>
<p>
You can specify various settings in the dialog.
</p>
<p><img src="../etc/tutorial_8_06.png" /></p>
<ul>
<li><b>SCF Type:</b> RHF, ROHF, or UHF.</li>
<li><b>Run Type:</b> Energy, Property, or Optimize.</li>
<li><b>Use internal coordinates for structure optimization:</b> Add instructions for automatic generation of internal Z-matrix. (<i>Note:</i> It cannot be used for linear molecules.)</li>
<li><b>Charge:</b> The (formal) charge of the molecule.</li>
<li><b>Multiplicity:</b> The spin multiplicity.</li>
<li><b>Use DFT:</b> Check if you want to use DFT.</li>
<li><b>DFT type:</b> At present only B3LYP is available in this dialog.</li>
<li><b>Basis set:</b> One of PM3, STO-3G, 3-21G, 6-31G, 6-31G(d), 6-31G(d, p), 6-311G, 6-311G(d, p), or LanL2DZ.</li>
<li><b>Use secondary basis set:</b> Check if you want to use another basis set for certain elements.</li>
<li><b>Elements:</b> The elements (comma separated) to use secondary basis set.</li>
<li><b>Basis set:</b> The secondary basis set.</li>
<li><b>Calculate electrostatic potential:</b> This is used for RESP charge calculation for AMBER.</li>
<li><b>Execite GAMESS on this machine:</b> (0.6.5 and later) Execute GAMESS, provided that GAMESS is installed on the same computer. Specify the full path of the GAMESS executable in "Path", and the number of CPU cores for calculation in "N of CPUs."<br />
(Note: GAMESS may not work depending on the version of the executable.)</li>
</ul>
<p>
When the calculation of GAMESS is complete, you will find two output files, namely *.log and *.dat. Either format can be imported by use of the "Import..." menu command. Some informations are included in both (<i>e.g.</i> coordinates during structural optimization), but other informations are only in one of these files (<i>e.g.</i> the full description of gaussian functions is only in the *.log file, whereas the orbital coefficients with full precision are only in the *.dat file). You need to be familiar with the structure of the GAMESS output files to fully utilize the GAMESS import capability of Molby.
</p>
<h2 id="gamess_resp" name="gamess_resp">3. Using GAMESS for calculation of the RESP charges</h2>
<p>
We already saw <a href="mm_minimize.html#electrostatic">how to assign partial charges</a> for evaluation of electrostatic interactions in MM calculations. There we used semi-empirical calculations, although <i>ab initio</i> calculations will give better results if possible. Here are instructions how to do it using GAMESS.
</p>
<p>
Select "MM/MD" &rarr; "Tools" &rarr; "GAMESS/RESP...".
</p>
<p><img src="../etc/tutorial_8_07.png" /></p>
<p>
The following window pops up. As the first step, press the "Create GAMESS Input..." button.
</p>
<p><img src="../etc/tutorial_8_08.png" /></p>
<p>
The familiar GAMESS dialog opens up. It is most important to turn on the "Calculate electrostatic potential (ESP)" checkbox (it should be turned on if you follow the steps as described here, but please double-check). Also make sure that the charge and multiplicity are correct, and select a suitable basis set (6-31G(d) is recommended).
</p>
<p><img src="../etc/tutorial_8_09.png" /></p>
<p>
Press OK to create the GAMESS input, and send it to GAMESS. The calculation will take time, so that you can finish Molby (after saving the molecule as a msbf file!), and work on something else at this stage.
</p>
<p>
After the GAMESS calculation is complete, open the same molecule, and select "MM/MD" &rarr; "Tools" &rarr; "GAMESS/RESP..." again. This time, follow the second step by pressing the "Import GAMESS dat..." button.
</p>
<p><img src="../etc/tutorial_8_10.png" /></p>
<p>
Select the GAMESS dat file (which should be available when the GAMESS calculation ends successfully), and import it. When the import is complete, the "Run RESP..." button should be enabled. If it does not, the imported dat file does not have the electrostatic potential information. Start over from the step 1, and make sure that the "Calculate electrostatic potential (ESP)" checkbox is on.
</p>
<p><img src="../etc/tutorial_8_11.png" /></p>
<p>
Press the "Run RESP..." button, and the following dialog opens. This is almost the same as the dialog for Antechamber <a href="mm_minimize.html#minimize">described before</a>.
</p>
<p><img src="../etc/tutorial_8_12.png" /></p>
<p>
Press the "OK" button, and the RESP charge will be assigned to the atoms.
</p>
</div>
<div class="contents" lang="ja">
<h1>第九段階：他の量子化学ソフトウェアとの連携</h1>
<p>
Molby は量子化学計算ソフトウェア  <a href="http://www.gaussian.com/">Gaussian</a>、<a href="http://www.msg.ameslab.gov/GAMESS/">GAMESS</a> のファイルを作成／読み込みする機能を持っています。現状では、Molby には極めて制限された機能しかないため、おそらく他の実績あるソフトウェアを使った方がよいでしょう。しかし、Molby の操作に慣れているなら、Gaussian や GAMESS の入力を作成して結果を読み込むのに Molby を使いたいことがあるかもしれません。どのようにすればよいかを説明します。
</p>
<p class="note">
当然のことながら、Gaussian や GAMESS のプログラムパッケージが使えることが前提です。これらが走るのは、Molby と同じマシン上でも異なるマシン（ワークステーション）上でも構いません。この項で説明するやり方で Molby を使う前に、これらのプログラムパッケージをどのように使うかを学んでおいてください。
</p>
<h2>1. Gaussian を使う</h2>
<p>
Gaussian の入力は "File" &rarr; "Export..." コマンドを使えば作成することができます。ファイルの拡張子は "gjf"（GaussianW での習慣）、または "com"（UNIX 版での習慣）です。
</p>
<p><img style="vertical-align:top;" src="../etc/tutorial_8_01.png" /><img src="../etc/tutorial_8_02.png" /></p>
<p>
できあがったファイルは次のようになります。Molby が作成できるのは、一種類の Gaussian 入力ファイル（PM3 による構造最適化）だけですが、Gaussian の入力ファイルを手作業で修正するのは比較的簡単です。
</p>
<p class="code">%Chk=benzene.chk
# PM3 Opt

 unnamed1; created by Molby at Sat Feb 11 00:30:21 +0900 2012

 0 1
C       -0.653000   0.585000  -1.068000
H       -1.158000   1.039000  -1.898000
C        0.729000   0.607000  -1.003000
H        1.295000   1.076000  -1.783000
C        1.382000   0.021000   0.069000
H        2.452000   0.038000   0.119000
C        0.651000  -0.586000   1.076000
H        1.156000  -1.039000   1.906000
C       -0.732000  -0.607000   1.012000
H       -1.298000  -1.077000   1.792000
C       -1.384000  -0.021000  -0.060000
H       -2.455000  -0.038000  -0.110000

</p>
<p>
構造最適化を行ったあとは、構造がどのように変化するか見てみたいと思うでしょう。これは、Gaussian 出力ファイルを読み込めば実現できます。拡張子は ".out" または ".log" でなくてはなりません。
</p>
<p><img style="vertical-align:top;" src="../etc/tutorial_8_03.png" /><img src="../etc/tutorial_8_04.png" /></p>
<h2>2. GAMESS を使う</h2>
<p>
GAMESS の入力を作成するのは Gaussian よりもずっと複雑なので、専用のダイアログが用意されています。このダイアログは、"QChem" &rarr; "Creating GAMESS input..." コマンドで開くことができます。
</p>
<p><img src="../etc/tutorial_8_05.png" /></p>
<p>
このダイアログでは、いろいろな設定を決めることができます。
</p>
<p><img src="../etc/tutorial_8_06.png" /></p>
<ul>
<li><b>SCF Type:</b> RHF, ROHF, または UHF.</li>
<li><b>Run Type:</b> Energy, Property, または Optimize.</li>
<li><b>Use internal coordinates for structure optimization:</b> 内部的に Z-matrix を自動生成するための命令を付け加えます。（<i>注：</i> 直線状分子には使えません。）</li>
<li><b>Charge:</b> 分子の形式電荷。</li>
<li><b>Multiplicity:</b> スピン多重度。</li>
<li><b>Use DFT:</b> DFT 計算を行うときチェックします。</li>
<li><b>DFT type:</b> このダイアログでは B3LYP のみ指定できます。</li>
<li><b>Basis set:</b> 以下の基底が指定できます：PM3, STO-3G, 3-21G, 6-31G, 6-31G(d), 6-31G(d, p), 6-311G, 6-311G(d, p), または LanL2DZ.</li>
<li><b>Use secondary basis set:</b> 特定の元素のみ別の基底を使いたいときチェックします。</li>
<li><b>Elements:</b> 別の基底を使う元素（コンマで区切って複数指定できます）。</li>
<li><b>Basis set:</b> 別の基底。</li>
<li><b>Calculate electrostatic potential:</b> RESP 電荷を求めるための静電ポテンシャルの計算を行う。</li>
<li><b>Execite GAMESS on this machine:</b> (0.6.5 以降) Molby と同じコンピュータに GAMESS がインストールされているとき、GAMESS を実行することができます。Path に GAMESS の実行ファイルのフルパス名、N of CPUs に使用する CPU のコア数を指定します。<br />
（注： GAMESS のバージョンによっては動作しないことがあります。）</li>
</ul>
<p>
GAMESS の計算が終了すると、*.log と *.dat の２つのファイルができます。どちらも "Import..." コマンドで読み込むことができます。ある種の情報（たとえば構造最適化途中の座標）はどちらのファイルにも含まれていますが、その他の情報はどちらか一方にしか含まれません（たとえば、基底を構成する Gaussian 関数の完全な係数は *.log ファイルにしかなく、精度の高い軌道係数は *.dat にしかありません）。GAMESS 読み込み機能を十分に活用するには、GAMESS の出力が何を含んでいるかをよく理解する必要があります。
</p>
<h2 id="gamess_resp" name="gamess_resp">3. GAMESS を用いて RESP 電荷を計算する</h2>
<p>
分子力学計算で静電相互作用を評価するための部分電荷の計算については<a href="mm_minimize.html#electrostatic">すでに説明しました</a>。そこでは半経験的分子軌道計算を用いましたが、可能ならば ab initio 計算の方がよい結果を与えます。GAMESS を使って計算する方法を説明します。
</p>
<p>
メニューより "MM/MD" &rarr; "Tools" &rarr; "GAMESS/RESP..." を選びます。
</p>
<p><img src="../etc/tutorial_8_07.png" /></p>
<p>
次のウィンドウが開きます。第１のステップとして、"Create GAMESS Input..." ボタンを押します。
</p>
<p><img src="../etc/tutorial_8_08.png" /></p>
<p>
GAMESS のダイアログが開きます。大切なのは、"Calculate electrostatic potential (ESP)" チェックボックスをオンにすることです（ここの手順に従えば、自動的にオンになっているはずですが、一応確認してください）。分子の電荷・スピン多重度が正しいことを確かめ，基底関数 (6-31G(d) がおすすめ) を指定してください。
</p>
<p><img src="../etc/tutorial_8_09.png" /></p>
<p>
OK ボタンを押して GAMESS 入力を作成し、GAMESS で計算を実行してください。計算には時間がかかりますから、この時点で Molby を終了して他の作業をしていただいて構いません（ただし、分子ファイルを mbsf 形式で保存することを忘れないで！）。
</p>
<p>
GAMESS 計算が完了したら、同じ分子ファイルを開き、"MM/MD" &rarr; "Tools" &rarr; "GAMESS/RESP..." をもう一度選択してください。今度は、第２ステップの "Import GAMESS dat..." ボタンを押します。
</p>
<p><img src="../etc/tutorial_8_10.png" /></p>
<p>
GAMESS の dat ファイルを選択し（GAMESS の計算が成功すればこれができているはずです）、読み込んでください。読み込みが完了したら、"Run RESP..." ボタンが有効になっているはずです。もしそうならなかったら、読み込んだ dat ファイルに静電ポテンシャルのデータが含まれなかったということです。もう一度第１ステップからやり直し、特に "Calculate electrostatic potential (ESP)" チェックボックスがオンになっていることを確かめてください。
</p>
<p><img src="../etc/tutorial_8_11.png" /></p>
<p>
"Run RESP..." ボタンを押すと、次のダイアログが開きます。これは、<a href="mm_minimize.html#minimize">前に説明した</a> Antechamber のダイアログとほとんど同じです。
</p>
<p><img src="../etc/tutorial_8_12.png" /></p>
<p>
"OK"ボタンを押すと、RESP 部分電荷が各原子に対してアサインされます。
</p>
</div>
<link id="#navigation" />
</div>

<div file="xtal.html">
<link rel="Up" href="tutorials.html" />
<link rel="Prev" href="qchem.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>Step Ten: Working with Crystal Structures</h1>
<p>
Information obtained from single-crystal X-ray analysis is a very important source of molecular structure. Molby can import crystallographic information files (CIFs) and handle structural data included in them. Although Molby does not have capability of solving structures from diffraction data, it does provide convenient features for viewing and examining crystal structures.
</p>
<h2>1. Importing a CIF file</h2>
<p>
Select "Open..." menu command in the "File" menu, and choose "Crystallographic Information File (CIF)" as the file type.
</p>
<p><img src="../etc/xtal_01.png" /></p>
<p>
Select a CIF file and hit "Open". If the molecule has crystallographic symmetry, it should have bonds including symmetry related atoms. In this case, a dialog like below is shown and you are asked how to handle such bonds.
</p>
<p><img src="../etc/xtal_02.png" /></p>
<p>
If the molecule is discrete with an imposed crystallographic symmetry, the default selection (the second one) should work all right. In other cases, where the molecule is an infinite chain, the first choice may make more sense. Expansion by symmetry is also available as a separate command, so it is also safe to ignore extra bonds at this stage (the third choice) and do symmetry expansion later.
</p>
<p>
After expansion, the molecule looks like this. The atoms with darker colors are "expanded atoms."
</p>
<p><img src="../etc/xtal_03.png" /></p>
<p>
Molby internally handles all atomic positions as cartesian coordinates. However, the fractional coordinates can be calculated "on-the-fly." In the property table, you can choose to display the fractional coordinates (together with the site occupancies and isotropic temperature factors) as below.
</p>
<p><img src="../etc/xtal_04.png" /><img src="../etc/xtal_05.png" /></p>

<h2>2. Examining the Crystal Structure</h2>
<p>
Commands for examining the crystal structure are available in the "Xtal" menu.
</p>
<p><img src="../etc/xtal_06.png" /></p>
<h3>2-1. Unit Cell</h2>
<p>
The "Unit Cell" command is used to set the unit cell parameters. It is also possible to set the origin and the unit cell axes directly.
</p>
<p><img src="../etc/xtal_07.png" /></p>
<h3>2-2. Symmetry Operation</h2>
<p>
The "Symmetry Operation" command is used to add/remove the symmetry operation, or change the space group.
</p>
<p><img src="../etc/xtal_08.png" /></p>
<p>
Hitting the "Select..." button causes another dialog to open, where you can choose one of the predefined space groups. All 230 space groups are included with various origin and axis settings (not all possible choices are covered though).
</p>
<p><img src="../etc/xtal_09.png" /></p>
<h3>2-3. Symmetry Expansion</h3>
<p>
The "Complete by Symmetry" command is used to expand the molecular fragment in the asymmetric unit. It is supposed to work similarly as the "expand fragments" option in loading CIFs, but the result may be different. (This is because, in the "Complete by Symmetry" command, the bonds between different asymmetric units are "guessed" based on interatomic distances instead of being read from the CIF file.)
</p>
<p><img src="../etc/xtal_10.png" /></p>
<p>
The "Create Packing Diagram" command generates symmetry-related atoms within the given range of the fractional coordinates.
</p>
<p><img src="../etc/xtal_11.png" /><img src="../etc/xtal_12.png" /></p>
<p>
The "Show Periodic Image" command does <i>not</i> generate new atoms, but shows the periodic images of the present unit cell.
</p>
<p><img src="../etc/xtal_13.png" /><img src="../etc/xtal_14.png" /></p>
<p>
The "Remove Expanded Atoms" command removes the atoms generated by symmetry expansion. There are two options; one is to remove all expanded atoms, and the other is to remove only those atoms that are included in completely expanded fragments (i.e. the fragments containing at least one non-expanded atoms will be kept unchanged).
</p>
<p><img src="../etc/xtal_15.png" /></p>
<p>
The result looks like below. Note that the periodic images are still shown, because they are not expanded atoms but just images shown on the screen.
</p>
<p><img src="../etc/xtal_16.png" /></p>

<h3>2-4. Bonds, Angles, and Planes</h3>
<p>
The "Bonds and Angles with Sigma..." command is used to calculate the interatomic distances and angles with the standard deviations.
</p>
<p><img src="../etc/xtal_17.png" /></p>
<p>
Hit "Add Bond" or "Add Angle" button to create a new entry, then select the atoms one by one in the main window. After adding one "bond" and one "angle", the window looks like below. Note that you can choose atoms that are not connected via chemical bonds.
</p>
<p><img src="../etc/xtal_18.png" /></p>
<p>
To use the calculated information in other applications (like pasting into a word processor), select the table rows and hit "Export to Clipboard." The information is copied as a plain text (one line per row) that can be pasted into other applications.
</p>
<p><img src="../etc/xtal_19.png" /><img src="../etc/xtal_20.png" /></p>
<p>
The "Best-Fit Planes" command is used for calculating mean planes, angles between the planes, and distances of atoms from the plane. After the dialog is opened, the set of atoms can be assigned by selecting the atoms in the main window and hit one of the "Set Current Selection" buttons.
</p>
<p><img src="../etc/xtal_21.png" /></p>

<h3>2-5. ORTEP Drawing</h3>
<p>
The "Show ORTEP" command open the dialog like below.
</p>
<p><img src="../etc/xtal_22.png" /></p>
<p>
The ORTEP drawing is created by the bundled ORTEP-III program. The following citation should be made when using the output.
</p>
<ul>
<li>
Burnett, M. N.; Johnson, C. K. <i>ORTEP-III: Oak Ridge Thermal Ellipsoid Plot Program for Crystal Structure Illustrations,</i> Oak Ridge National Laboratory Report ORNL-6895, 1996.
</li>
</ul>
<p>
On this dialog, you can choose the appearance of the atoms and bonds. The orientation of the drawing is similar (although not completely the same) as in the main window. The drawing can be exported as an ORTEP input file or a graphic file (either as an encapsulated PostScript file, a PNG file or a TIFF file). When exporting to a bitmap file, the drawing is done at resolution of 360 dpi.
</p>
<p><img src="../etc/xtal_23.png" /></p>
</div>
<div class="contents" lang="ja">
<h1>第十段階：結晶構造を取り扱う</h1>
</div>
<link id="#navigation" />
</div>

<div file="ruby.html">
<link rel="Up" href="tutorials.html" />
<link rel="Prev" href="xtal.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>Step Eleven: Using Embedded Ruby Interpreter</h1>
<p>
One of the most useful features of Molby is the embedded Ruby interpreter. When working on molecular modeling, it is often necessary to modify the model according to some mathematical relations. It is also convenient if we can extract some molecular information by automated "scripts" (i.e. computer programs), and export as a text file that can be processed by graphing software. The embedded Ruby interpreter is very useful under these circumstances. Actually, many functions of Molby itself are implemented by Ruby scripts.
</p>
<p>
To use the embedded Ruby interpreter in Molby, you need to be familiar with the Ruby programming language. You can find several good on-line tutorials in the Internet. However, you can also get the idea by going through the following sections.
</p>
<h2>1. Using the Ruby Console</h2>
<p>
The Ruby <i>console window</i> is open when Molby starts up.
</p>
<p><img src="../etc/ruby_01.png" /></p>
<p>
On this window, you can execute Ruby scripts in an interactive manner. Let us try something on it now. Make the console window active by clicking on it, and type "1+2" followed by hitting the Return key. You will find this:
</p>
<p class="code">% <span class="blue">1+2</span>
<span class="red">--&gt; 3</span>
%
</p>
<p>
The Ruby interpreter calculated "1+2", and displayed the answer (3) in the following line.
</p>
<p>
You can give a longer expression including parenthesis.
</p>
<p class="code">% <span class="blue">(13.0*13.0+7.0*7.0)/1.365</span>
<span class="red">--&gt;159.70695970696</span>
%
</p>
<p>
Or use common mathematical functions.
</p>
<p class="code">% <span class="blue">exp(-2.0) * (sin(0.25) + cos(0.25))</span>
<span class="red">--&gt;0.1646105219232536</span>
%
</p>
<p class="note">Usually in Ruby, you need to say <code>Math.exp</code> or <code>Math.sin</code> when using these mathematical functions. In Molby, the prefix <code>Math</code> is not necessary, because Molby automatically "includes" the <code>Math</code> module on startup.</p>
<p>
You can also use <i>Strings</i>, which is a series of characters.
</p>
<p class="code">% <span class="blue">"C" + "32"</span>
<span class="red">--&gt;"C32"</span>
%
</p>
<p>
The "32" here is not a number but a string, because it is surrounded by quotation marks. If you omit these quotation marks, what happens?
</p>
<p class="code">% <span class="blue">"C" + 32</span>
</p>
<p><img src="../etc/ruby_02.png" /></p>
<p>
Molby complains with this error dialog. It says "in '+': can't convert Fixnum into String," which means the integer 32 cannot be added to a string "C". Such kind of "type mismatch" error occurs very often, so please get used to it and learn how to fix it.
</p>
<p>
Another useful feature of Ruby is an <i>Array</i>, which is an ordered collection of other Ruby objects. An array is expressed by comma-separated values surrounded by a pair of brackets.
</p>
<p class="code">% <span class="blue">[1, 2, 3]</span>
<span class="red">--&gt;[1, 2, 3]</span>
%
</p>
<p>
Any Ruby object can be stored in a <i>variable</i>. The name of variables should begin with a lowercase alphabet and should consist of alphabets, number characters and underline "_".
</p>
<p class="code">% <span class="blue">a = ["apple", "orange", "grape"]</span>
<span class="red">--&gt;["apple", "orange", "grape"]</span>
% <span class="blue">a[0]</span>     <span class="comment"># This shows how to access the array elements</span>
<span class="red">--&gt;"apple"</span>
</p>

<h2>2. How to Handle Molecules in Molby Scripts</h2>
<p>
The examples so far used only built-in types (<code>Integer</code>, <code>String</code>, <code>Array</code>) in Ruby, but you will definitely need to handle <i>Molecules</i> from your Molby scripts. Suppose we have a benzene molecule (again).
</p>
<p><img src="../etc/ruby_03.png" /></p>
<p>
What if you want to convert it to chlorobenzene? There are two GUI ways; double-click on the H1 atom, and enter "Cl" into the dialog box, or double-click on the "H" text in the "element" column of the property table and change it to "Cl". But there is also a "Ruby" way, as follows:
</p>
<p class="code">% <span class="blue">atoms[1].element = "Cl"</span>
<span class="red">--&gt;"Cl"</span>
%
</p>
<p><img src="../etc/ruby_04.png" /></p>
<p>
This short piece of code implies some important concepts for coding in Molby. First, <code>atoms</code> denotes the atoms in the <i>current molecule</i>, which is the molecule in the frontmost window (except for the console window). <code>atoms</code> is not really an Array (as in the Ruby terminology), but can be used in a similar way as Array in many aspects. Specifically, it can be "indexed" to extract a specific atom.
</p>
<p class="code">atoms[i]   <span class="comment">#  Gives the i-th atom in the current molecule</span>
</p>
<p>
Please make sure to say <code>atoms[i]</code>, not <code>atom[i]</code>. This may be confusing, but it is because <code>atoms</code> is a collection of atoms and <code>[]</code> denotes "extraction of the i-th element."
</p>
<p>
The second point in the above example is <code>.element = "Cl"</code>. In Ruby, a period (<code>.</code>) followed by a word (<code>element</code>) indicates a "method call." <i>Method</i> is a technical term in Ruby programming language; it is a function that is specific to an object. In this case, <code>atoms[1]</code> is an object, and it has a method named <code>element=</code> (including the last equal sign) whose meaning is "to change the element as indicated by the string value in the right side." In this way, the script <code>atoms[1].element = "Cl"</code> causes the element of the atom 1 changed to chlorine.
</p>
<p>
What if you want to change all hydrogen atoms to chlorine? Here is the code:
</p>
<p class="code">% <span class="blue">natoms.times { |i| if atoms[i].element == "H"; atoms[i].element = "Cl"; end }</span>
<span class="red">--&gt;12</span>
%
</p>
<p>
This is far more complicated than the previous example. A step-by-step explanation follows.
</p>
<p>
<code>natoms</code> gives the number of atoms in the current molecule as an integer number. This is actually a method call (<code>natoms</code> is a method of a <code>Molecule</code> object). Why a method is called even though no period is preceding the word? It is because Ruby has a feature called "implicit method call." This will be explained in more detail later.
</p>
<p class="code">natoms   <span class="comment"># Gives 12</span>
</p>
<p>
<code>times</code> is a method of <code>Integer</code> (which is a built-in class of Ruby), which causes the following code surrounded by a pair of braces to be repeated the given number of times.
</p>
<p class="code">natoms.times { ... }   <span class="comment"># { ... } is executed 12 times</span>
</p>
<p class="note">The code within the braces is called <i>"block"</i> in Ruby terminology.</p>
<p>
In the repeated code (or <i>"block"</i>), it is very likely that you want to know "how many times have I repeated?" This is achieved by declaring a variable name at the top of the block, surrounded by two vertical bars.
</p>
<p class="code">natoms.times { |i| ... }   <span class="comment"># In { ... }, the variable i indicates the number of repeats</span>
</p>
<p>
The following piece of codes is often used for testing. (<code>puts</code> prints the arguments to the console.)
</p>
<p class="code">% <span class="blue">natoms.times { |i| puts i }</span>
0
1
2
3
4
5
6
7
8
9
10
11
<span class="red">--&gt;12</span>
</p>
<p>
The "12" in the last line is the "result value" of the method <code>times</code>, and the numbers 0 to 11 are the outputs from the <code>puts</code> method. Now you can see the block was executed 12 times with changing the variable <code>i</code> from 0 to 11.
</p>
<p>
In the block, there is an <code>if</code> statement:
</p>
<p class="code">if atoms[i].element == "H"; atoms[i].element = "Cl"; end
</p>
<p>
The <code>if</code> statement has the following general form:
</p>
<p class="code">if <i>&lt;condition&gt;</i>; <i>&lt;statements&gt;</i>; end
</p>
<p>
The <i>&lt;condition&gt;</i> is evaluated first, and if it is "true", the <i>&lt;statements&gt;</i> are executed; otherwise the <i>&lt;statements&gt;</i> are skipped.
</p>
<p>
<i>Note:</i> Ruby interprets only <code>false</code> and <code>nil</code> as non-true values. Other values are all "true". Specifically, the number <code>0</code> (zero) and an empty string (<code>""</code>) are evaluated to "true" (this is unlike other programming language such as Perl). Many Ruby methods returns <code>nil</code> in case of failure; such methods are suitable for the condition part.
</p>
<p>
Finally, the <code>element</code> method in the following code is different from the <code>element=</code> method that we previously used:
</p>
<p class="code">atoms[i].element == "H"
</p>
<p>
In this case, the following symbol is "<code>==</code>", which means "are these equal?". This is distinct from the symbol "<code>=</code>", which means "the right side is assigned to the left side." The <code>element</code> symbol is interpreted as the <code>element=</code> method only when it is followed by the assignment symbol "<code>=</code>". The above code is not the case, so that it is interpreted as the <code>element</code> method, which returns the present element symbol as a <code>String</code>.
</p>
<p>
After execution of the script, the molecule should look like this:
</p>
<p><img src="../etc/ruby_05.png" /></p>

<h2>3. About the "Implicit" Method Call</h2>
<p>
In the preceding section, we saw that <code>natoms</code> was a method of a <code>Molecule</code> object.
</p>
<p class="code">natoms     <span class="comment"># 12, in case of benzene</span>
</p>
<p>
Why this symbol <code>natoms</code> is regarded as a method call? Actually, when the Ruby interpreter finds a symbol beginning with a lowercase alphabet, it looks for a (local) variable first, and if none is found, then it assumes that the symbol is a method belonging to the <i>"current object"</i>. Since Ruby is an object-oriented language, there is always a "current object", which is denoted as <code>self</code>. We can see it on our console:
</p>
<p class="code">% <span class="blue">self</span>
<span class="red">--&gt;Molecule["unnamed1"]</span>
%
</p>
<p>
This piece of code indicates that the "current object" is a <code>Molecule</code> object. In fact, the <code>Molecule</code> object corresponding to the frontmost window becomes the "current object" when a script is executed on the Molby console. 
</p>
<p class="note">When no molecule is open, the "current object" is "main", which is the standard toplevel object in Ruby.</p>
<p>
Sometimes you happen to define a variable with the same name as a method of <code>Molecule</code>. In that case, access to the variable is preferred and the method is no longer called.
</p>
<p class="code">% <span class="blue">natoms = 2</span>    <span class="comment"># Define a variable</span>
<span class="red">--&gt;2</span>
% <span class="blue">natoms</span>    <span class="comment"># Now this is an access to the variable, not a method call</span>
<span class="red">--&gt;2</span>
%
</p>
<p>
In this situation, you can explicitly request a method call by specifying <code>self</code>.
</p>
<p class="code">% <span class="blue">self.natoms</span>    <span class="comment"># This is a method call</span>
<span class="red">--&gt;12</span>
%
</p>
<p>
A special case is the methods with the assignment symbol ("<code>=</code>"). For example, a method <code>show_hydrogens=</code> can control whether the hydrogen atoms are shown or not. However, without specifying <code>self</code>, the expression is always regarded as the assignment to a local variable. Therefore, <code>self</code> should be always explicitly given.
</p>
<p class="code">% <span class="blue">show_hydrogens = false</span>    <span class="comment"># This does not change the Molecule's state, just changes a local variable</span>
<span class="red">--&gt;false</span>
% <span class="blue">self.show_hydrogens = false</span>    <span class="comment"># This changes the Molecule's state</span>
<span class="red">--&gt;false</span>
%
</p>
<h2>4. Executing a Ruby Script on a File</h2>
<p>
From the Ruby console, you can only execute a one-line script. For more complex scripts, or if you want to use the script many times over, it will be more convenient to store the script in a file and execute it. The "Execute Script..." command in the "Script" menu does this job.
</p>
<p><img src="../etc/ruby_06.png" /></p>
<p>
There are endless possibilities for the script; here are presented only a few examples. The first script is to create a table of bond lengths including metal atoms (Fe):
</p>
<p class="code"><span class="comment">#  Create a bond table including Fe
#  Requires Molby</span>
fp = open("bond_table.txt", "w") <span class="comment">#  Create an output file</span>
atoms.each { |ap|  <span class="comment">#  This is another way to repeat over all atoms;
                   #  ap points to the atom on each iteration</span>
  if ap.element == "Fe"
    r1 = ap.r               <span class="comment"># The cartesian coordinate of Fe</span>
    ap.connects.each { |n|  <span class="comment"># ap.connects is an array of atom indices connected to this atom</span>
      ap2 = atoms[n]        <span class="comment"># The atom connected to Fe</span>
      r2 = ap2.r            <span class="comment"># The cartesian coordinate of the atom</span>
      d = (r - r2).length   <span class="comment"># The bond length</span>
      fp.printf "%s-%s %.3f\n", ap.name, ap2.name, d <span class="comment"># Write a table entry to the file</span>
    }                       <span class="comment"># End loop (ap.connects)</span>
  end                       <span class="comment"># End if</span>
}                           <span class="comment"># End loop (atoms.each)</span>
fp.close                    <span class="comment"># We are done with this file</span>
</p>
<p>
Save this text to a file, select "Execute Script..." command (be sure that the target molecule is on the front), and choose the script file. After execution, a file named "bond_table.txt" will be generated in the same directory as the script file.
</p>
<p>
Here is another example, which works on a MD trajectory. For each frame, the molecule is reoriented so that the atom 0 is at the origin and atoms 1 and 2 are on the xy plane (with the atom 1 on the x-axis), and calculate the center of mass of the atoms 6 to 11. Such processing is useful to visualize how a particular part of the molecule moves around throughout the MD run.
</p>
<p class="code"><span class="comment">#  Reorient the molecule and extract center of some group
#  Requires Molby</span>
fp = open("extract_group.txt", "w") <span class="comment">#  Create an output file</span>
each_frame { |n|  <span class="comment">#  This is an idiom to iterate over all frames</span>
  rotate_with_axis(1, 2, 0)  <span class="comment">#  Reorientation of the molecule is so frequently used
                             #  that the Molecule class has a method to do it</span>
  r = center_of_mass(6..11)  <span class="comment">#  Also has a method to calculate the center of mass</span>
  fp.printf "%d %.6f %.6f %.6f\n", n, r.x, r.y, r.z  <span class="comment">#  Write the coordinates</span>
}
fp.close                     <span class="comment">#  We are done with this file</span>
</p>
<p>
The last example generates a model of carbon nanotube with any chirality and length as you like.
</p>
<p class="code"><span class="comment">#  Create a model of carbon nanotube
#  Requires Molby</span>
r = 1.42     <span class="comment">#  The C-C bond length</span>
n = 10       <span class="comment">#  The chirality index</span>
m = 5        <span class="comment">#  (ibid)</span>
aspect = 5.0 <span class="comment">#  The aspect ratio (length / diameter)</span>

k = aspect / (PI * sqrt(3.0))
points = []
<span class="comment">#  The limiting points are (0, 0), (n, m), (k(n+2m), -k(2n+m)), (k(n+2m)+n, -k(2n+m)+n)
#  Search for the lattice points that are within the parallelogram
#  surrounded by the above points
#  det is the determinant of the matrix that converts the unit cell to the above parallelogram </span>
delta = 2 * k * (n * n + m * m + n * m)
(0..(k * (n + 2 * m) + n).ceil).each { |s|
  ((-k * (2 * n + m)).floor..m).each { |t|
    [0, 2.0/3.0].each { |d|   <span class="comment">#  For two lattice points within the unit cell</span>
      ss = (k * (2 * n + m) * (s + d) + k * (n + 2 * m) * (t + d)) / delta
      tt = (m * (s + d) - n * (t + d)) / delta
      if ss &gt;= 0.0 &amp;&amp; ss &lt; 1.0 &amp;&amp; tt &gt;= 0.0 &amp;&amp; tt &lt;= 1.0
        points.push([ss, tt, s, t])   <span class="comment">#  This point is within the parallelogram</span>
      end
    }
  }
}
<span class="comment">#  Create nanotube: line up [ss, tt] into cylindric shape</span>
rad = sqrt(3.0) * r * sqrt(n * n + m * m + n * m) / (2 * PI)
len = rad * 2 * aspect
mol = Molecule.new
points.each { |p|
  ap = mol.create_atom
  ap.element = "C"
  ap.atom_type = "ca"
  ap.r = [rad * cos(2 * PI * p[0]), rad * sin(2 * PI * p[0]), len * p[1]]
}
mol.guess_bonds
<span class="comment">#  Show the result in a new window</span>
mol2 = Molecule.open
mol2.add(mol)
</p>
<p><img src="../etc/ruby_07.png" /><img src="../etc/ruby_08.png" /></p>

<h2>5. Where to Go from Here</h2>
<p>
The embedded Ruby capability is very strong, and cannot be fully explained in this short tutorial. If you are interested, read carefully the <a href="ruby_ref.html">reference of the Ruby extension</a>. There are also many scripts in the Molby application, which you can examine by opening the "Scripts" folder (which is within the Application package in Mac OS X, and in the same folder as the Molby application in Windows).
</p>
</div>
<div class="contents" lang="ja">
<h1>第十一段階：組み込み Ruby インタプリタを使う</h1>
<p>
Molby の最も有用な機能の１つは、内蔵の Ruby インタプリタです。分子モデリングを行うとき、ある数学的な規則に従ってモデルを変更したいことがしばしばあります。また、分子のある種の情報を自動化された「スクリプト」（コンピュータプログラム）で抽出してテキストとして書き出し、グラフ描画ソフトウェアで処理することも有用です。内蔵 Ruby インタプリタは、このような場合に威力を発揮します。実は、Molby の機能の多くの部分は Ruby スクリプトで実装されているのです。
</p>
<p>
Molby の内蔵 Ruby インタプリタを使うためには、プログラミング言語 Ruby の知識が必要です。インターネット上で良いオンラインチュートリアルを見つけてください。もっとも、以下の解説を読めば、ある程度のイメージはつかめるでしょう。
</p>
<h2>1. Ruby コンソールを使う</h2>
<p>
Molby が起動すると、Ruby の「コンソールウィンドウ」が開きます。
</p>
<p><img src="../etc/ruby_01.png" /></p>
<p>
このウィンドウ上で、Ruby スクリプトを対話的に実行することができます。いくつか試してみましょう。コンソールウィンドウをクリックしてアクティブにして、"1+2"、続いてリターンキーをタイプしてください。次のようになります。
</p>
<p class="code">% <span class="blue">1+2</span>
<span class="red">--&gt; 3</span>
%
</p>
<p>
Ruby インタプリタが "1+2" を計算し、答え (3) を次の行に表示したところです。
</p>
<p>
カッコを含む長い式も計算できます。
</p>
<p class="code">% <span class="blue">(13.0*13.0+7.0*7.0)/1.365</span>
<span class="red">--&gt;159.70695970696</span>
%
</p>
<p>
数学関数も使うことができます。
</p>
<p class="code">% <span class="blue">exp(-2.0) * (sin(0.25) + cos(0.25))</span>
<span class="red">--&gt;0.1646105219232536</span>
%
</p>
<p class="note">通常 Ruby では、これらの数学関数を使うときには <code>Math.exp</code>, <code>Math.sin</code> のように書かなくてはなりません。Molby では、<code>Math</code> という接頭辞は必要ありません。これは Molby が起動時に <code>Math</code> モジュールを "include" するためです。</p>
<p>
文字列 <i>(Strings)</i> を使うこともできます。
</p>
<p class="code">% <span class="blue">"C" + "32"</span>
<span class="red">--&gt;"C32"</span>
%
</p>
<p>
ここの "32" は数ではなく文字列です。引用符で囲まれているからです。引用符を省略するとどうなるでしょう？
</p>
<p class="code">% <span class="blue">"C" + 32</span>
</p>
<p><img src="../etc/ruby_02.png" /></p>
<p>
Molby はエラーメッセージ "in '+': can't convert Fixnum into String" を表示します。これは、「整数」32 を「文字列」"C" に足すことはできないことを意味しています。このような「型が違う」エラーはとてもよく起きるので、どのように直せばいいかをよく理解しておいてください。
</p>
<p>
Ruby のもう１つの便利な機能は「配列」<i>(Array)</i> です。これは、他の Ruby オブジェクトを順番に並べたものです。配列は、値をコンマで区切って角括弧 [] で囲むことで表します。
</p>
<p class="code">% <span class="blue">[1, 2, 3]</span>
<span class="red">--&gt;[1, 2, 3]</span>
%
</p>
<p>
Ruby のオブジェクトは「変数」に格納することができます。変数の名前は、小文字のアルファベットで始まり、数字またはアルファベット ("_" を含む) の並びでなくてはなりません。
</p>
<p class="code">% <span class="blue">a = ["apple", "orange", "grape"]</span>
<span class="red">--&gt;["apple", "orange", "grape"]</span>
% <span class="blue">a[0]</span>     <span class="comment"># 配列の要素を指定する</span>
<span class="red">--&gt;"apple"</span>
</p>

<h2>2. Molby スクリプトで分子を扱う</h2>
<p>
ここまでの例では、Ruby の組み込み型 <code>Integer</code>, <code>String</code>, <code>Array</code> を使ってきましたが、Molby スクリプトでは「分子」を扱うことが必要になります。ベンゼン分子があるとしましょう。
</p>
<p><img src="../etc/ruby_03.png" /></p>
<p>
これをクロロベンゼンに変えたいとします。グラフィックインターフェイスでは２つのやり方があります。H1原子をダブルクリックしてダイアログボックスに "Cl" と入力するか、属性テーブルの "element" のセルで "H" を "Cl" に変えます。これを Ruby スクリプトで行うには、次のようにします。
</p>
<p class="code">% <span class="blue">atoms[1].element = "Cl"</span>
<span class="red">--&gt;"Cl"</span>
%
</p>
<p><img src="../etc/ruby_04.png" /></p>
<p>
この短いコードに、Molby でのコーディングの重要な技法が含まれています。まず、<code>atoms</code> は「現在の分子」（コンソールウィンドウを除いて最も手前側にあるウィンドウの分子）に含まれる原子の並びを表します。<code>atoms</code> は Ruby の配列 (<code>Array</code>) ではありませんが、多くの点で配列と同じように使うことができます。特に、「添字」をつけて特定の原子を指定することができます。
</p>
<p class="code">atoms[i]   <span class="comment">#  現在の分子の i 番目の原子</span>
</p>
<p>
<code>atom[i]</code> ではなく <code>atoms[i]</code> であることに注意してください。混乱しますが、これは <code>atoms</code> が原子の並びで <code>[]</code> が「…番目の要素を取り出す」という機能を表すためです。
</p>
<p>
次は <code>.element = "Cl"</code> です。Ruby では、ピリオド (<code>.</code>) に続けて単語 (<code>element</code>) を書くと、「メソッド呼び出し」になります。「メソッド」とはプログラミング言語 Ruby の用語で、ある対象（オブジェクト）に固有の動作を指します。この場合は、<code>atoms[1]</code> がオブジェクトで、<code>element=</code> という名前のメソッドを持っています（最後の '=' を含みます）。このメソッドは、「その原子の元素記号を右辺の文字列で表されたものに変える」という働きをします。このようにして、スクリプト <code>atoms[1].element = "Cl"</code> は、原子１の元素記号を Cl に変えます。
</p>
<p>
もし、全部の水素原子を塩素に変えたいとしたらどうでしょう？　次のようにします。
</p>
<p class="code">% <span class="blue">natoms.times { |i| if atoms[i].element == "H"; atoms[i].element = "Cl"; end }</span>
<span class="red">--&gt;12</span>
%
</p>
<p>
これは前の例よりずっと複雑です。ステップごとに説明していきます。
</p>
<p>
<code>natoms</code> は、現在の分子の原子数を整数で返します。これは実はメソッド呼び出しで、<code>Molecule</code> 型オブジェクトのメソッド <code>natoms</code> を呼んでいます。ピリオドがないのにメソッドが呼び出されているのはなぜでしょう？　これは Ruby 言語の仕様に、「暗黙のメソッド呼び出し」があるためです。あとでもう少し詳しく説明します。
</p>
<p class="code">natoms   <span class="comment"># 12 となる</span>
</p>
<p>
<code>times</code> は、<code>Integer</code> （これは Ruby の組み込み型です）のメソッドです。その後ろの中括弧 {} で囲まれたコードを、指定した回数実行します。
</p>
<p class="code">natoms.times { ... }   <span class="comment"># { ... } が 12 回実行される</span>
</p>
<p class="note">中括弧で囲んだコードを Ruby の用語で「ブロック」と呼びます。</p>
<p>
繰り返すコード（ブロック）の中で、「今実行しているのは何回目？」かを知りたいことがあります。このためには、ブロックの先頭で、２本の縦棒 "|" で囲んで変数を指定します。
</p>
<p class="code">natoms.times { |i| ... }   <span class="comment"># { ... } の中で、変数 i は繰り返し回数を表す</span>
</p>
<p>
次のようなコードがテストのためによく使われます。(<code>puts</code> は与えられたオブジェクトをコンソールに出力します。)
</p>
<p class="code">% <span class="blue">natoms.times { |i| puts i }</span>
0
1
2
3
4
5
6
7
8
9
10
11
<span class="red">--&gt;12</span>
</p>
<p>
最後の行の "12" は、<code>times</code> メソッドの「戻り値」です。その上の 0 から 11 の数は、<code>puts</code> メソッドからの出力です。ブロックが 12 回実行され、変数 <code>i</code> が 0 から 11 まで変化したことがわかりますね。
</p>
<p>
ブロックの中には、<code>if</code> 文があります。
</p>
<p class="code">if atoms[i].element == "H"; atoms[i].element = "Cl"; end
</p>
<p>
<code>if</code> 文の一般形は次の通りです。
</p>
<p class="code">if <i>&lt;条件&gt;</i>; <i>&lt;実行文&gt;</i>; end
</p>
<p>
まず <i>&lt;条件&gt;</i> が評価されます。それが「真」ならば、<i>&lt;実行文&gt;</i> が実行されます。条件が「真」でなければ、<i>&lt;実行文&gt;</i> はスキップされます。
</p>
<p>
<i>注:</i> Ruby は <code>false</code> と <code>nil</code> だけを「真でない」値とします。その他の値はすべて「真」です。特に、数値の <code>0</code>（ゼロ）と空の文字列 (<code>""</code>) も「真」となります（これは Perl などの他のプログラミング言語とは異なります）。多くの Ruby メソッドは、失敗したときに nil を返します。これらのメソッドは条件部分にそのまま使えます。
</p>
<p>
最後に出てくる <code>element</code> メソッドは、先に出て来た <code>element=</code> メソッドとは違います。
</p>
<p class="code">atoms[i].element == "H"
</p>
<p>
この場合は、<code>element</code> の次に来る記号は "<code>==</code>" で、これは「２つの値は等しいか？」という意味です。この記号は "<code>=</code>" とは違います。後者は「右辺を左辺に代入する」という意味です。<code>element</code> という記号は、その次に "<code>=</code>" 記号が来るときに限って、"<code>element=</code>" メソッドとして解釈されます。この場合はそうではないので、<code>element</code> メソッドが呼び出されます。このメソッドは、現在の元素記号を <code>String</code> （文字列）として返します。
</p>
<p>
スクリプトを実行したら、分子は次のようになるはずです。
</p>
<p><img src="../etc/ruby_05.png" /></p>

<h2>3. 暗黙のメソッド呼び出し</h2>
<p>
前の節で、<code>natoms</code> は <code>Molecule</code> オブジェクトのメソッドであることを学びました。
</p>
<p class="code">natoms     <span class="comment"># 12 （ベンゼンの場合）</span>
</p>
<p>
なぜこの <code>natoms</code> はメソッド呼び出しと見なされるのでしょう？　実は、Ruby インタプリタ（Ruby スクリプトを実行するプログラム）は小文字のアルファベットで始まる単語を見つけると、まず変数（ローカル変数）を探し、それが見つからなければ「現在のオブジェクト」に属するメソッドであると見なすのです。Ruby は「オブジェクト指向言語」なので、Ruby スクリプトの実行中は必ず「現在のオブジェクト」が存在しています。これを <code>self</code> と呼びます。コンソールで試してみましょう：
</p>
<p class="code">% <span class="blue">self</span>
<span class="red">--&gt;Molecule["unnamed1"]</span>
%
</p>
<p>
この結果は、「現在のオブジェクト」が "unnamed1" という分子を表す <code>Molecule</code> オブジェクトであることを示しています。Molby コンソールでスクリプトを実行する時は、最前面にあるウィンドウの分子に対応する <code>Molecule</code> オブジェクトが「現在のオブジェクト」になります。
</p>
<p class="note">分子のウィンドウが１つも開いていない時は、現在のオブジェクトは <code>main</code> になります。これは Ruby 起動時の「現在のオブジェクト」と同じものです。</p>
<p>
ときどき、<code>Molecule</code> が持つメソッド名と同じ名前の変数を作ってしまうことがあります。この場合、変数へのアクセスが優先されますので、メソッドを呼び出すことはできなくなります。
</p>
<p class="code">% <span class="blue">natoms = 2</span>    <span class="comment"># 変数 natoms を定義</span>
<span class="red">--&gt;2</span>
% <span class="blue">natoms</span>    <span class="comment"># これは変数へのアクセスになり、メソッド呼び出しではない</span>
<span class="red">--&gt;2</span>
%
</p>
<p>
この場合でも、<code>self</code> を指定すればメソッドを呼び出すことができます。
</p>
<p class="code">% <span class="blue">self.natoms</span>    <span class="comment"># これはメソッド呼び出し</span>
<span class="red">--&gt;12</span>
%
</p>
<p>
特に注意が必要なのは、代入記号 ("<code>=</code>") を持つメソッドです。例えば、<code>show_hydrogens=</code> というメソッドは、水素原子を表示するかどうかを指定するものです。しかし、<code>self</code> を使わないと、ローカル変数への代入になってしまいます。従って、この場合は常に <code>self</code> を指定する必要があります。
</p>
<p class="code">% <span class="blue">show_hydrogens = false</span>    <span class="comment"># これはローカル変数への代入で、分子の状態は変わらない</span>
<span class="red">--&gt;false</span>
% <span class="blue">self.show_hydrogens = false</span>    <span class="comment"># これはメソッド呼び出しで、分子の状態を変える</span>
<span class="red">--&gt;false</span>
%
</p>
<h2>4. ファイル上の Ruby スクリプトを実行する</h2>
<p>
Ruby コンソール上では、１行のスクリプトしか実行できません。もっと複雑なスクリプトを実行したい時や、同じスクリプトを何度も実行したい時は、ファイルにスクリプトを格納して実行する方が便利です。"Script" メニューの "Execute Script..." コマンドでこれが実現できます。
</p>
<p><img src="../etc/ruby_06.png" /></p>
<p>
スクリプトには無限の可能性があります。いくつかの例をここに示します。最初のものは、「鉄原子を含む結合長のテーブルを作る」スクリプトです。
</p>
<p class="code"><span class="comment">#  Create a bond table including Fe
#  Requires Molby</span>
fp = open("bond_table.txt", "w") <span class="comment">#  Create an output file</span>
atoms.each { |ap|  <span class="comment">#  This is another way to repeat over all atoms;
                   #  ap points to the atom on each iteration</span>
  if ap.element == "Fe"
    r1 = ap.r               <span class="comment"># The cartesian coordinate of Fe</span>
    ap.connects.each { |n|  <span class="comment"># ap.connects is an array of atom indices connected to this atom</span>
      ap2 = atoms[n]        <span class="comment"># The atom connected to Fe</span>
      r2 = ap2.r            <span class="comment"># The cartesian coordinate of the atom</span>
      d = (r - r2).length   <span class="comment"># The bond length</span>
      fp.printf "%s-%s %.3f\n", ap.name, ap2.name, d <span class="comment"># Write a table entry to the file</span>
    }                       <span class="comment"># End loop (ap.connects)</span>
  end                       <span class="comment"># End if</span>
}                           <span class="comment"># End loop (atoms.each)</span>
fp.close                    <span class="comment"># We are done with this file</span>
</p>
<p>
このテキストをファイルに保存し、"Execute Script..." コマンドを実行し（目的の分子が一番前のウィンドウに表示されていることを確かめて）、スクリプトファイルを選びます。実行後、"bond_table.txt" というファイルが、スクリプトファイルと同じディレクトリに作成されています。
</p>
<p>
次の例は、MD トラジェクトリを処理するものです。各フレームに対して、原子 0 が原点、原子 1, 2 が xy 平面上（原子 1 が x 軸上）に来るように分子を再配向して、原子 6 から 11 の重心を計算します。このような処理は、MD の結果分子のある部分がどのように動くかを可視化するのに便利です。
</p>
<p class="code"><span class="comment">#  Reorient the molecule and extract center of some group
#  Requires Molby</span>
fp = open("extract_group.txt", "w") <span class="comment">#  Create an output file</span>
each_frame { |n|  <span class="comment">#  This is an idiom to iterate over all frames</span>
  rotate_with_axis(1, 2, 0)  <span class="comment">#  Reorientation of the molecule is so frequently used
                             #  that the Molecule class has a method to do it</span>
  r = center_of_mass(6..11)  <span class="comment">#  Also has a method to calculate the center of mass</span>
  fp.printf "%d %.6f %.6f %.6f\n", n, r.x, r.y, r.z  <span class="comment">#  Write the coordinates</span>
}
fp.close                     <span class="comment">#  We are done with this file</span>
</p>
<p>
最後の例は、任意のキラリティ・長さのカーボンナノチューブのモデルを作成するスクリプトです。
</p>
<p class="code"><span class="comment">#  Create a model of carbon nanotube
#  Requires Molby</span>
r = 1.42     <span class="comment">#  The C-C bond length</span>
n = 10       <span class="comment">#  The chirality index</span>
m = 5        <span class="comment">#  (ibid)</span>
aspect = 5.0 <span class="comment">#  The aspect ratio (length / diameter)</span>

k = aspect / (PI * sqrt(3.0))
points = []
<span class="comment">#  The limiting points are (0, 0), (n, m), (k(n+2m), -k(2n+m)), (k(n+2m)+n, -k(2n+m)+n)
#  Search for the lattice points that are within the parallelogram
#  surrounded by the above points
#  det is the determinant of the matrix that converts the unit cell to the above parallelogram </span>
delta = 2 * k * (n * n + m * m + n * m)
(0..(k * (n + 2 * m) + n).ceil).each { |s|
  ((-k * (2 * n + m)).floor..m).each { |t|
    [0, 2.0/3.0].each { |d|   <span class="comment">#  For two lattice points within the unit cell</span>
      ss = (k * (2 * n + m) * (s + d) + k * (n + 2 * m) * (t + d)) / delta
      tt = (m * (s + d) - n * (t + d)) / delta
      if ss &gt;= 0.0 &amp;&amp; ss &lt; 1.0 &amp;&amp; tt &gt;= 0.0 &amp;&amp; tt &lt;= 1.0
        points.push([ss, tt, s, t])   <span class="comment">#  This point is within the parallelogram</span>
      end
    }
  }
}
<span class="comment">#  Create nanotube: line up [ss, tt] into cylindric shape</span>
rad = sqrt(3.0) * r * sqrt(n * n + m * m + n * m) / (2 * PI)
len = rad * 2 * aspect
mol = Molecule.new
points.each { |p|
  ap = mol.create_atom
  ap.element = "C"
  ap.atom_type = "ca"
  ap.r = [rad * cos(2 * PI * p[0]), rad * sin(2 * PI * p[0]), len * p[1]]
}
mol.guess_bonds
<span class="comment">#  Show the result in a new window</span>
mol2 = Molecule.open
mol2.add(mol)
</p>
<p><img src="../etc/ruby_07.png" /><img src="../etc/ruby_08.png" /></p>

<h2>5. 次に学ぶべきこと</h2>
<p>
組み込み Ruby インタプリタは非常に強力であるため、この短いチュートリアルでは説明しきれません。興味があるなら、<a href="ruby_ref.html">Ruby 拡張のリファレンス</a> に目を通してください。また、Molby アプリケーション本体にはたくさんの Ruby スクリプトが内蔵されています。"Scripts" フォルダを参照してください（Mac OS X では Molby アプリケーションパッケージの中、Windows では Molby アプリケーションと同じフォルダにあります）。
</p>
</div>
<link id="#navigation" />
</div>

<div file="appendix.html">
<link rel="Up" href="index.html" />
<link rel="Prev" href="tutorials.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>Appendix</h1>
<link id="#toc" />
</div>
<div class="contents" lang="ja">
<h1>付録</h1>
<link id="#toc" />
</div>
<link id="#navigation" />
</div>

<div file="ruby_ref.html">
<link rel="Up" href="appendix.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>Ruby Extension Reference</h1>
<p>
The following classes/module/exception are defined in the embedded Ruby interpreter in Molby. The methods defined in the module <code>Kernel</code> can be used as if they are builtin functions, like in the standard Ruby interpreter. All other classes and <code>MolbyError</code> exception are defined under the a module <code>Molby</code>. However, <code>Molby::</code> prefix is not necessary because <code>include Molby</code> is invoked on startup.
</p>
<p class="note">
On startup, <code>include Math</code> is also invoked, so that the methods and constants in the <code>Math</code> module can also be used without prefix.
</p>
<p>
It is recommended for you to read the document of the most important class <a href="molby_rb/Molecule.html">Molecule</a>. Follow the links as necessary, and you will understand how other classes are defined and used.
</p>
<h3 class="section-bar">Classes</h3>
<ul>
<li><a href="molby_rb/AtomRef.html">AtomRef</a></li>
<li><a href="molby_rb/Dialog.html">Dialog</a></li>
<li><a href="molby_rb/DialogItem.html">DialogItem</a></li>
<li><a href="molby_rb/IntGroup.html">IntGroup</a></li>
<li><a href="molby_rb/LAMatrix.html">LAMatrix</a></li>
<li><a href="molby_rb/MDArena.html">MDArena</a></li>
<li><a href="molby_rb/MolEnumerable.html">MolEnumerable</a></li>
<li><a href="molby_rb/Molecule.html">Molecule</a></li>
<li><a href="molby_rb/Parameter.html">Parameter</a></li>
<li><a href="molby_rb/ParameterRef.html">ParameterRef</a></li>
<li><a href="molby_rb/ParEnumerable.html">ParEnumerable</a></li>
<li><a href="molby_rb/Transform.html">Transform</a></li>
<li><a href="molby_rb/Vector3D.html">Vector3D</a></li>
</ul>
<h3 class="section-bar">Module</h3>
<ul>
<li><a href="molby_rb/Kernel.html">Kernel</a></li>
<li><a href="molby_rb/MolbyModule.html">Molby</a></li>
</ul>
<h3 class="section-bar">Exception</h3>
<ul>
<li><a href="molby_rb/MolbyError.html">MolbyError</a></li>
</ul>
</div>
<div class="contents" lang="ja">
<h1>Ruby 拡張リファレンス</h1>
<p>
以下のクラス／モジュール／例外が Molby 内蔵の Ruby インタプリタに組み込まれています。<code>Kernel</code> モジュールのメソッドは、通常の Ruby インタプリタと同様に組み込み関数のように使うことができます。その他のクラスと <code>MolbyError</code> 例外は <code>Molby</code> モジュールの下に定義されています。ただし、起動時に <code>include Molby</code> が呼び出されるため、<code>Molby::</code> 接頭辞は必要ありません。
</p>
<p class="note">
起動時には <code>include Math</code> も呼び出されるため、<code>Math</code> モジュールのメソッドや定数も接頭辞なしで使うことができます。
</p>
<p>
最も重要なクラスは <a href="molby_rb/Molecule.html">Molecule</a> なので、このドキュメントを最初に読むことをお勧めします。ここから必要に応じてリンクをたどっていけば、他のクラスがどのように定義され使われるかが理解しやすくなります。
</p>
<h3 class="section-bar">Classes</h3>
<ul>
<li><a href="molby_rb/AtomRef.html">AtomRef</a></li>
<li><a href="molby_rb/Dialog.html">Dialog</a></li>
<li><a href="molby_rb/DialogItem.html">DialogItem</a></li>
<li><a href="molby_rb/IntGroup.html">IntGroup</a></li>
<li><a href="molby_rb/LAMatrix.html">LAMatrix</a></li>
<li><a href="molby_rb/MDArena.html">MDArena</a></li>
<li><a href="molby_rb/MolEnumerable.html">MolEnumerable</a></li>
<li><a href="molby_rb/Molecule.html">Molecule</a></li>
<li><a href="molby_rb/Parameter.html">Parameter</a></li>
<li><a href="molby_rb/ParameterRef.html">ParameterRef</a></li>
<li><a href="molby_rb/ParEnumerable.html">ParEnumerable</a></li>
<li><a href="molby_rb/Transform.html">Transform</a></li>
<li><a href="molby_rb/Vector3D.html">Vector3D</a></li>
</ul>
<h3 class="section-bar">Module</h3>
<ul>
<li><a href="molby_rb/Kernel.html">Kernel</a></li>
<li><a href="molby_rb/MolbyModule.html">Molby</a></li>
</ul>
<h3 class="section-bar">Exception</h3>
<ul>
<li><a href="molby_rb/MolbyError.html">MolbyError</a></li>
</ul>
</div>
<link id="#navigation" />
</div>

<div file="filter_kit_howto.html">
<link rel="Up" href="appendix.html" />
<link rel="Prev" href="ruby_ref.html" />
<link id="#header" />
<div class="contents" lang="en">
<h1>Filter Kit How-to</h1>
<p>
In the research of chemistry, we sometimes a simple processing of text files. Ruby is particularly suitable for such purposes. To make the use of Ruby easier, Molby provides a special capability called "filter kit" (version 0.6.4 and later). The name originates from the "UNIX" culture, where small programs for text processing are called "filters".
</p>
<p>
Here is a description of making a filter script. As a demonstration, the filter here is a very simple function; it appends a sequential line number on each line.
</p>
<p><img src="../etc/filter_01.png" />&nbsp;&nbsp;&nbsp;<img src="../etc/filter_02.png" /></p>
<p>
To write a filter, we create a new text file, with extention ".rb" or ".mrb". Former is conventional as a Ruby script, but latter may be useful to specify Ruby scripts for Molby.
</p>
<p>
We start from the following line:
</p>
<p class="code">Dialog.filter_kit("Filter Sample", "This is a sample filter.") { |args|
</p>
<p>
The method <code>Dialog.filter_kit</code> takes two arguments, the window title and the message. It also requires a block, which actually contains the main program.
</p>
<p>
When the user presses the "Select Files" button and choose files (which can be multiple), the block is executed with the array of the chosen file names as the argument. The block body is written as follows:
</p>
<p class="code"><span class="linenumber">  1 </span> Dialog.filter_kit("Filter Sample", "This is a sample filter.") { |args|
<span class="linenumber">  2 </span>   args.each { |fname|
<span class="linenumber">  3 </span>    fp = open(fname, "r")
<span class="linenumber">  4 </span>    if fp == nil
<span class="linenumber">  5 </span>      error_message_box("Cannot open file: #{arg}")
<span class="linenumber">  6 </span>      next
<span class="linenumber">  7 </span>    end
<span class="linenumber">  8 </span>    puts fname
<span class="linenumber">  9 </span>    a = fp.readlines
<span class="linenumber"> 10 </span>    fp.close
<span class="linenumber"> 11 </span>    File.rename(fname, fname + "~")
<span class="linenumber"> 12 </span>    fp2 = open(fname, "w")
<span class="linenumber"> 13 </span>    a.each_with_index { |ln, n|
<span class="linenumber"> 14 </span>      ln = (n + 1).to_s + "  " + ln
<span class="linenumber"> 15 </span>      fp2.print ln
<span class="linenumber"> 16 </span>    }
<span class="linenumber"> 17 </span>    fp2.close
<span class="linenumber"> 18 </span>  }
</p>
<ul>
<li>Line 2: The code in the following braces (<code>{}</code>) is repeated over all files.</li>
<li>Line 3: Open the file for reading.</li>
<li>Lines 4-7: If the file cannot be opened, then show the error message and continue to the next file.</li>
<li>Line 8: Display the filename as information. The output will be displayed in the text box within the filter dialog.</li>
<li>Line 9: Read all lines from the file and store in an array.</li>
<li>Line 10: Now we are done with this file, so close the file.</li>
<li>Line 11: Rename the file name with a tilda (~) at the end. (It is also possible to change the extension, for example; however, you need to learn about "regular expression" to write the code.)</li>
<li>Line 12: Open the file with the same name, this time for writing. We also need error handling for this operation as in line 4-7, which is omitted here for clarity.</li>
<li>Line 13: Repeat the following block (the code in the braces) for all elements in the array. The element and its index are given to the block as <code>ln</code> and <code>n</code>, respectively.</li>
<li>Line 14: Append the line number. <code>(n + 1)</code> denotes the line number (because the array index begins with zero), and <code>to_s</code> generates a String object from an Integer.</li>
<li>Line 15: Write the line to the file.</li>
<li>Line 17: Close the file.</li>
</ul>
<p>
The above text is saved as "filter_sample.rb" (the filename can be arbitrary except for the extension). Open it with Molby, and you will get the filter running.
</p>
</div>
<div class="contents" lang="ja">
<h1>Filter Kit の使い方</h1>
<p>
化学の研究では、テキストファイルに簡単な処理を加えたいことがときどきあります。Ruby はこの目的に特に適しています。Ruby を簡単に使えるようにするため、Molby は "filter kit" という特別な機能を持っています（バージョン 0.6.4 以降）。Filter という名前は "UNIX" の文化から来ており、テキストを処理する小さなプログラムのことを指します。
</p>
<p>
以下にフィルタスクリプトの作り方を解説します。説明のため、ごく単純な機能を持ったものを作ります。ファイルの各行に行番号をつけるものです。
</p>
<p><img src="../etc/filter_01.png" />&nbsp;&nbsp;&nbsp;<img src="../etc/filter_02.png" /></p>
<p>
フィルタを書くためには、新しいテキストファイルを作って、拡張子を ".rb" か ".mrb" とします。前者が Ruby スクリプトとして一般的なものですが、後者は Molby 専用のスクリプトを示すために使うことができます。
</p>
<p>
まず次の行から始めます。
</p>
<p class="code">Dialog.filter_kit("Filter Sample", "This is a sample filter.") { |args|
</p>
<p>
<code>Dialog.filter_kit</code> というメソッドは２つの引数をとります。ウィンドウのタイトルと、メッセージです。この他にブロックが必要で、その中にメインプログラムを置きます。
</p>
<p>
フィルタのユーザーが "Select Files" ボタンでファイルを選ぶと（複数のファイルを選択できます）、ブロックが実行され、選択されたファイル名の配列 (Array) が引数として渡されます。ブロックの本体は次のように書きます。
</p>
<p class="code"><span class="linenumber">  1 </span> Dialog.filter_kit("Filter Sample", "This is a sample filter.") { |args|
<span class="linenumber">  2 </span>   args.each { |fname|
<span class="linenumber">  3 </span>    fp = open(fname, "r")
<span class="linenumber">  4 </span>    if fp == nil
<span class="linenumber">  5 </span>      error_message_box("Cannot open file: #{arg}")
<span class="linenumber">  6 </span>      next
<span class="linenumber">  7 </span>    end
<span class="linenumber">  8 </span>    puts fname
<span class="linenumber">  9 </span>    a = fp.readlines
<span class="linenumber"> 10 </span>    fp.close
<span class="linenumber"> 11 </span>    File.rename(fname, fname + "~")
<span class="linenumber"> 12 </span>    fp2 = open(fname, "w")
<span class="linenumber"> 13 </span>    a.each_with_index { |ln, n|
<span class="linenumber"> 14 </span>      ln = (n + 1).to_s + "  " + ln
<span class="linenumber"> 15 </span>      fp2.print ln
<span class="linenumber"> 16 </span>    }
<span class="linenumber"> 17 </span>    fp2.close
<span class="linenumber"> 18 </span>  }
</p>
<ul>
<li>2行: 以下のブレース (<code>{}</code>) 内のコードを各ファイルに対して繰り返します。</li>
<li>3行: ファイルを読み取り用にオープンします。</li>
<li>4-7行: ファイルがオープンできなければ、エラーメッセージを表示して、次のファイルに進みます。</li>
<li>8行: ファイル名を表示します。出力は、ダイアログの中のテキストボックスに表示されます。</li>
<li>9行: ファイルのすべての行を読み込んで配列に格納します。</li>
<li>10行: 読み込みが終わったので、ファイルを閉じます。</li>
<li>11行: ファイル名の後ろにチルダ (~) をつけます。（たとえば拡張子を変更する、などの処理も可能ですが、コードを書くには「正規表現」を学ぶ必要があります。）</li>
<li>12行: ファイルを同じ名前で、今度は書き込み用にオープンします。本当は 4-7 行と同じようにエラー処理が必要ですが、ここでは簡単のため省略してあります。</li>
<li>13行: 以下のブロック（ブレース内のコード）を配列内のすべての要素（つまりすべての行）について繰り返します。配列要素（つまりそれぞれの行）とそのインデックスがそれぞれ <code>ln</code> and <code>n</code> としてブロックに渡されます。</li>
<li>14行: 行番号をつけます。<code>(n + 1)</code> が行番号になります（インデックスは０から始まるため）。<code>to_s</code> は整数を文字列に変換します。</li>
<li>15行: 行をファイルに書き出します。</li>
<li>17行: ファイルを閉じて書き込みを完結します。</li>
</ul>
<p>
上のテキストを "filter_sample.rb" として保存します（拡張子が正しければ、ファイル名は何でも構いません）。このファイルを Molby で開けば、フィルタとして使うことができます。
</p>
</div>
<link id="#navigation" />
</div>

</body>
</html>
